<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IRON</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- 核心依赖库 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 样式配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#000000', 
                        surface: '#1c1c1e', 
                        surfaceHighlight: '#2c2c2e',
                        primary: '#0a84ff', 
                        accent: '#30d158',
                        danger: '#ff453a', 
                        orange: '#ff9f0a',
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        glow: {
                            'from': { boxShadow: '0 0 10px -5px #0a84ff' },
                            'to': { boxShadow: '0 0 20px 5px rgba(10, 132, 255, 0.3)' }
                        }
                    },
                    backgroundImage: {
                        'gemini-gradient': 'linear-gradient(to bottom right, #1e3a8a, #000000, #000000)',
                        'card-gradient': 'linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)',
                        'card-active': 'linear-gradient(145deg, rgba(10, 132, 255, 0.15) 0%, rgba(10, 132, 255, 0.05) 100%)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 全局样式重置 */
        body { 
            background-color: #000000;
            color: #f2f2f7; 
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "ss01", "ss02"; 
            /* 允许背景透出 */
            background-image: radial-gradient(circle at 50% 0%, rgba(10, 132, 255, 0.1), transparent 40%),
                              radial-gradient(circle at 80% 20%, rgba(50, 215, 75, 0.05), transparent 30%);
            background-attachment: fixed;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 优化的毛玻璃效果 */
        .glass {
            background: rgba(20, 20, 22, 0.7);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* 头部导航专用玻璃 */
        .nav-glass {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* 针对 Header 的特殊修正：确保不挡住状态栏 */
        .header-spacing {
            padding-top: calc(env(safe-area-inset-top) + 12px); 
            padding-bottom: 16px;
        }

        /* 字体阴影 */
        .text-glow {
            text-shadow: 0 0 20px rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="h-full selection:bg-primary selection:text-white">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 0. 美化组件 & 常量 ---

        const QUOTES = [
            { text: "No man has the right to be an amateur in the matter of physical training.", author: "Socrates" },
            { text: "The resistance that you fight physically in the gym and the resistance that you fight in life can only build a strong character.", author: "Arnold Schwarzenegger" },
            { text: "Everybody wants to be a bodybuilder, but nobody wants to lift no heavy-ass weights.", author: "Ronnie Coleman" },
            { text: "It is a shame for a man to grow old without seeing the beauty and strength of which his body is capable.", author: "Socrates" },
            { text: "Discipline is doing what needs to be done, even if you don't want to do it.", author: "Unknown" },
            { text: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", author: "Aristotle" }
        ];
        
        const GeminiStar = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
                <path d="M12 0C12 6.62742 17.3726 12 24 12C17.3726 12 12 17.3726 12 24C12 17.3726 6.62742 12 0 12C6.62742 12 12 6.62742 12 0Z" fill="url(#paint0_linear)"/>
                <defs>
                    <linearGradient id="paint0_linear" x1="12" y1="0" x2="12" y2="24" gradientUnits="userSpaceOnUse">
                        <stop stopColor="#30d158"/>
                        <stop offset="0.5" stopColor="#0a84ff"/>
                        <stop offset="1" stopColor="#5e5ce6"/>
                    </linearGradient>
                </defs>
            </svg>
        );

        const BackgroundGlow = () => (
            <div className="fixed inset-0 pointer-events-none z-[-1] overflow-hidden">
                <div className="absolute top-[-100px] left-[-50px] w-64 h-64 bg-primary/20 rounded-full blur-[80px] opacity-40 animate-pulse-slow"></div>
                <div className="absolute bottom-[20%] right-[-50px] w-72 h-72 bg-accent/10 rounded-full blur-[80px] opacity-30"></div>
            </div>
        );

        // --- 1. 数据模型与存储 ---
        const STORAGE_KEY = 'iron_app_data_v8_ultimate'; 
        const initialData = {
            templates: [],        
            customExercises: [],  
            history: [],
            importedLibrary: [],
            userStats: { 
                height: '', // cm
                weight: '', // kg
                totalVolume: 0,
                totalWorkouts: 0,
                // 新增: 按部位记录恢复状态 { "CHEST": "2023-10-01T10:00:00.000Z", ... } (记录预计恢复完成的时间)
                muscleRecovery: {} 
            }
        };

        const useStorage = () => {
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : initialData;
                } catch (e) { return initialData; }
            });
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);
            return [data, setData];
        };

        // --- 2. 核心算法: 科学恢复 & 有氧计算 ---
        
        // 2.1 力量训练恢复算法 (Banister Modified - Site Specific)
        const calculateRecovery = (exercises) => {
            let totalVolume = 0;
            let recoveryUpdates = {}; // { MUSCLE: hoursToAdd }
            
            // 基础恢复时间表 (小时) - 基于 1000kg 容量的标准强度
            const BASE_RECOVERY = {
                'LEGS': 48, 'BACK': 48, // 大肌群
                'CHEST': 36, 'GLUTES': 48,
                'SHOULDERS': 24, 'ARMS': 24, 'ABS': 24, 'CORE': 24 // 小肌群
            };

            exercises.forEach(ex => {
                let exVolume = 0;
                let exStress = 0;
                
                ex.sets.forEach(set => {
                    if (set.completed && set.weight && set.reps) {
                        const vol = parseFloat(set.weight) * parseFloat(set.reps);
                        exVolume += vol;
                        
                        // RPE 强度系数修正
                        const rpe = set.rpe ? parseFloat(set.rpe) : 7;
                        const stressFactor = 1 + ((rpe - 7) * 0.2); // RPE每增加1，压力增加20%
                        exStress += vol * stressFactor;
                    }
                });
                
                totalVolume += exVolume;

                // 计算该部位需要的恢复时间
                if (ex.category) {
                    const base = BASE_RECOVERY[ex.category] || 24;
                    // 算法: (有效负荷 / 1000) * 基础时间 + 基础底数
                    // 这里的逻辑是：只要练了，至少需要12小时，然后根据容量线性增加
                    const calculatedHours = 12 + (exStress / 1000) * (base / 2);
                    
                    // 取最大值 (如果同一个部位练了多个动作)
                    if (!recoveryUpdates[ex.category]) {
                        recoveryUpdates[ex.category] = calculatedHours;
                    } else {
                        recoveryUpdates[ex.category] += calculatedHours * 0.5; // 同部位后续动作疲劳递减累加
                    }
                }
            });

            // 封顶 96 小时 (4天)
            Object.keys(recoveryUpdates).forEach(k => {
                if (recoveryUpdates[k] > 96) recoveryUpdates[k] = 96;
                recoveryUpdates[k] = Math.round(recoveryUpdates[k]);
            });

            return {
                volume: totalVolume,
                recoveryMap: recoveryUpdates // { LEGS: 48, CHEST: 30 ... }
            };
        };

        // 2.2 有氧热量计算 (ACSM 公式)
        const calculateCardioCalories = (type, minutes, speedKmh, inclinePercent, weightKg) => {
            if (!weightKg) weightKg = 70; // 默认体重
            const speedMmin = (speedKmh * 1000) / 60; // 速度转为 m/min
            const grade = inclinePercent / 100; // 坡度百分比转小数
            let vo2 = 3.5; // 静态 VO2 (mL/kg/min)

            // ACSM 公式
            if (type === 'walk' || type === 'uphill') {
                // Walking Equation: H + V + R (Horizontal + Vertical + Resting)
                // VO2 = (0.1 * S) + (1.8 * S * G) + 3.5
                vo2 = (0.1 * speedMmin) + (1.8 * speedMmin * grade) + 3.5;
            } else if (type === 'run') {
                // Running Equation: VO2 = (0.2 * S) + (0.9 * S * G) + 3.5
                vo2 = (0.2 * speedMmin) + (0.9 * speedMmin * grade) + 3.5;
            }

            // 消耗热量 (kcal/min) = (VO2 * Weight) / 200
            // 解释: VO2 (mL/kg/min) * kg / 1000 = L/min. L/min * 5 kcal/L = kcal/min.
            const kcalPerMin = (vo2 * weightKg) / 200;
            return Math.round(kcalPerMin * minutes);
        };

        // --- 3. 外部数据 & 辅助 ---
        const useExternalLibrary = (setAppData) => {
            useEffect(() => {
                const fetchLibrary = async () => {
                    try {
                        const response = await fetch('./exercise_library.json');
                        if (!response.ok) throw new Error('Err');
                        const json = await response.json();
                        const parseRecursive = (obj) => {
                            let extracted = [];
                            if (Array.isArray(obj)) {
                                return obj.map(ex => ({
                                    id: `ext_${(ex.id || ex.name).replace(/\s+/g, '')}_${Math.random().toString(36).substr(2,5)}`,
                                    name: ex.name,
                                    category: normalizeCategory([...(ex.muscle_group||[]), ...(ex.primary_muscle||[])]),
                                    instructions: ex.instructions,
                                    mistakes: ex.common_mistakes
                                }));
                            }
                            if (typeof obj === 'object' && obj !== null) {
                                Object.keys(obj).forEach(key => {
                                    if(key!=='version') extracted = [...extracted, ...parseRecursive(obj[key])];
                                });
                            }
                            return extracted;
                        };
                        const exercises = parseRecursive(json);
                        if(exercises.length > 0) setAppData(prev => ({ ...prev, importedLibrary: exercises }));
                    } catch (error) {}
                };
                fetchLibrary();
            }, []);
        };

        const normalizeCategory = (input) => {
            const str = JSON.stringify(input).toLowerCase();
            if (str.includes('chest') || str.includes('胸')) return 'CHEST';
            if (str.includes('back') || str.includes('背') || str.includes('lats')) return 'BACK';
            if (str.includes('leg') || str.includes('腿') || str.includes('squat')) return 'LEGS';
            if (str.includes('glute') || str.includes('臀')) return 'GLUTES';
            if (str.includes('shoulder') || str.includes('delt') || str.includes('肩')) return 'SHOULDERS';
            if (str.includes('arm') || str.includes('biceps') || str.includes('triceps')) return 'ARMS';
            if (str.includes('abs') || str.includes('core') || str.includes('腹')) return 'ABS';
            return 'CORE';
        };

        // --- 4. UI 组件 ---
        const Icon = ({ name, size = 20, className, strokeWidth = 2, onClick }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                     lucide.createIcons({
                        icons: { [name]: iconRef.current },
                        attrs: { 'stroke-width': strokeWidth, width: size, height: size, class: className }
                    });
                }
            }, [name, size, className, strokeWidth]);
            return <i ref={iconRef} data-lucide={name} onClick={onClick}></i>;
        };

        // --- 5. 主程序 ---
        const App = () => {
            const [appData, setAppData] = useStorage();
            useExternalLibrary(setAppData); 

            // View: 'templates' | 'workout' | 'me' | 'summary' | 'cardio'
            const [view, setView] = useState('templates'); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // 状态
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [newTemplateExercises, setNewTemplateExercises] = useState([]);
            const [showExerciseSelector, setShowExerciseSelector] = useState(false);
            const [exerciseDetails, setExerciseDetails] = useState(null); 
            const [activeWorkoutData, setActiveWorkoutData] = useState({ exercises: [], startTime: null });
            const [durationStr, setDurationStr] = useState("00:00:00");
            const [summaryData, setSummaryData] = useState(null);

            const fullLibrary = useMemo(() => [...appData.importedLibrary, ...appData.customExercises], [appData]);

            // --- 业务逻辑 ---
            const handleExport = () => { 
                /* ... (保留原有逻辑) ... */ 
                const dataStr = JSON.stringify(appData);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'iron_backup_' + new Date().toISOString().slice(0,10) + '.json';
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };
            const handleImport = (event) => { 
                /* ... (保留原有逻辑) ... */ 
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (imported.templates || imported.history) {
                            setAppData(imported);
                            alert('数据恢复成功');
                            setIsSettingsOpen(false);
                        } else {
                            alert('文件格式不正确');
                        }
                    } catch (err) {
                        alert('导入失败，请检查文件');
                    }
                };
                reader.readAsText(file);
            };

            const startWorkout = (exercises = []) => {
                const exObjects = exercises.map(exId => {
                    const found = fullLibrary.find(e => e.id === exId);
                    return found ? { ...found, sets: [{ id: Date.now(), weight: '', reps: '', rpe: '', completed: false }] } : null;
                }).filter(Boolean);
                setActiveWorkoutData({ exercises: exObjects, startTime: new Date() });
                setView('workout');
            };

            const finishWorkout = () => {
                const endTime = new Date();
                const recoveryResult = calculateRecovery(activeWorkoutData.exercises);
                const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                
                // 计算新的恢复时间戳
                const newMuscleRecovery = { ...appData.userStats.muscleRecovery };
                const now = Date.now();
                
                Object.keys(recoveryResult.recoveryMap).forEach(muscle => {
                    const hoursNeeded = recoveryResult.recoveryMap[muscle];
                    const recoveryEndTime = now + (hoursNeeded * 3600 * 1000);
                    // 如果旧的恢复时间比现在还晚，就从旧的时间叠加，或者取最大值？
                    // 简化策略：取 (当前时间+新疲劳) 和 (旧恢复时间+少量叠加) 的较晚者，防止疲劳无限叠加不合理
                    // 这里采用简单的：重置为当前+所需时间
                    newMuscleRecovery[muscle] = new Date(recoveryEndTime).toISOString();
                });

                const record = {
                    id: Date.now(),
                    type: 'strength',
                    date: endTime.toISOString(),
                    duration: Math.floor((endTime - activeWorkoutData.startTime) / 1000),
                    volume: recoveryResult.volume,
                    muscles: Object.keys(recoveryResult.recoveryMap)
                };

                setAppData(prev => ({
                    ...prev,
                    history: [record, ...prev.history],
                    userStats: {
                        ...prev.userStats,
                        totalVolume: (prev.userStats.totalVolume || 0) + recoveryResult.volume,
                        totalWorkouts: (prev.userStats.totalWorkouts || 0) + 1,
                        muscleRecovery: newMuscleRecovery
                    }
                }));

                setSummaryData({ 
                    volume: recoveryResult.volume, 
                    muscles: Object.keys(recoveryResult.recoveryMap),
                    recoveryMap: recoveryResult.recoveryMap,
                    quote 
                });
                setView('summary');
            };

            // 计时器
            useEffect(() => {
                if (view !== 'workout' || !activeWorkoutData.startTime) return;
                const timer = setInterval(() => {
                    const diff = Math.floor((new Date() - activeWorkoutData.startTime) / 1000);
                    const h = Math.floor(diff / 3600);
                    const m = Math.floor((diff % 3600) / 60);
                    const s = diff % 60;
                    setDurationStr(`${h > 0 ? h + ':' : ''}${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [view, activeWorkoutData.startTime]);

            // --- 组件: 动作选择器 ---
            const ExerciseSelector = () => { /* ...保留不变... */ 
                const [filter, setFilter] = useState('CHEST');
                const categories = [ { id: 'CHEST', name: '胸部' }, { id: 'BACK', name: '背部' }, { id: 'LEGS', name: '腿部' }, { id: 'SHOULDERS', name: '肩部' }, { id: 'ARMS', name: '手臂' }, { id: 'GLUTES', name: '臀部' }, { id: 'ABS', name: '腹肌' }, ];
                const list = fullLibrary.filter(ex => ex.category === filter);
                return (
                    <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col animate-slide-up">
                        <div className="header-spacing px-4 flex justify-between items-center bg-black/50 border-b border-white/10">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><GeminiStar size={20} />动作库</h2>
                            <button onClick={() => setShowExerciseSelector(false)} className="text-primary font-medium">关闭</button>
                        </div>
                        <div className="p-4 flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {categories.map(c => (
                                <button key={c.id} onClick={() => setFilter(c.id)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${filter === c.id ? 'bg-white text-black border-white shadow-glow' : 'bg-surfaceHighlight text-zinc-400 border-transparent'}`}>{c.name}</button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto px-4 pb-safe space-y-3">
                            {list.map(ex => (
                                <div key={ex.id} className="p-4 bg-card-gradient border border-white/5 rounded-2xl flex justify-between items-center active:scale-[0.99] transition-transform" onClick={() => {
                                         if(isCreatingTemplate) setNewTemplateExercises(prev => [...prev, ex]);
                                         else if(view === 'workout') setActiveWorkoutData(prev => ({...prev, exercises: [...prev.exercises, {...ex, sets:[{id:Date.now(), weight:'', reps:'', completed:false}]}]}));
                                         setShowExerciseSelector(false);
                                     }}>
                                    <div><div className="text-white font-medium">{ex.name}</div><div className="text-xs text-zinc-500 mt-0.5">{ex.category}</div></div>
                                    <span className="text-xs font-bold text-black bg-white px-3 py-1 rounded-full">添加</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // --- 视图: 有氧运动 (Cardio) ---
            const CardioView = () => {
                const [type, setType] = useState('walk'); // walk, uphill, run
                const [duration, setDuration] = useState(''); // min
                const [speed, setSpeed] = useState(''); // km/h
                const [incline, setIncline] = useState(''); // %
                const [result, setResult] = useState(null);

                const calculate = () => {
                    const weight = parseFloat(appData.userStats.weight) || 70;
                    if (!duration || !speed) return alert("请输入时间和速度");
                    const inc = type === 'walk' || type === 'run' || type === 'uphill' ? (incline || 0) : 0;
                    const cals = calculateCardioCalories(type, parseFloat(duration), parseFloat(speed), parseFloat(inc), weight);
                    setResult(cals);
                    
                    // 自动保存到历史?
                    /* const record = { id: Date.now(), type: 'cardio', date: new Date().toISOString(), duration: duration*60, calories: cals, details: {type, speed, incline} };
                    setAppData(prev => ({...prev, history: [record, ...prev.history]})); 
                    */
                };

                const saveRecord = () => {
                    const record = { 
                        id: Date.now(), 
                        type: 'cardio', 
                        date: new Date().toISOString(), 
                        duration: parseFloat(duration)*60, 
                        calories: result, 
                        details: {type, speed, incline} 
                    };
                    setAppData(prev => ({
                        ...prev, 
                        history: [record, ...prev.history],
                        userStats: {
                            ...prev.userStats,
                            totalWorkouts: (prev.userStats.totalWorkouts || 0) + 1
                        }
                    }));
                    alert("已记录到 我的 页面");
                    setResult(null); // Reset after save
                };

                const TYPES = [
                    { id: 'walk', name: '户外/跑步机慢走', icon: 'footprints' },
                    { id: 'uphill', name: '爬坡走 (高坡度)', icon: 'mountain' }, // Changed id to uphill to avoid conflict
                    { id: 'run', name: '跑步/冲刺', icon: 'wind' },
                ];

                return (
                    <div className="min-h-screen pb-24 relative animate-fade-in">
                        <BackgroundGlow />
                        <div className="header-spacing px-6 border-b border-white/5 nav-glass sticky top-0 z-20">
                            <h1 className="text-2xl font-black text-white italic">CARDIO</h1>
                        </div>

                        <div className="p-6 space-y-8">
                            {/* 类型选择 */}
                            <div className="grid grid-cols-3 gap-3">
                                {TYPES.map((t, idx) => (
                                    <button key={idx} onClick={() => setType(t.id)} className={`flex flex-col items-center justify-center p-4 rounded-2xl border transition-all ${type === t.id ? 'bg-primary text-white border-primary shadow-glow' : 'bg-surfaceHighlight border-white/5 text-zinc-500'}`}>
                                        <Icon name={t.icon} size={24} />
                                        <span className="text-[10px] font-bold mt-2 text-center leading-tight">{t.name}</span>
                                    </button>
                                ))}
                            </div>

                            {/* 输入表单 */}
                            <div className="bg-card-gradient border border-white/5 rounded-3xl p-6 space-y-5">
                                <div className="space-y-2">
                                    <label className="text-xs font-bold text-zinc-400 uppercase ml-1">时长 (分钟)</label>
                                    <div className="relative">
                                        <input type="number" value={duration} onChange={e=>setDuration(e.target.value)} placeholder="30" className="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-4 text-white font-bold text-lg outline-none focus:border-primary/50" />
                                        <span className="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold">MIN</span>
                                    </div>
                                </div>
                                <div className="flex gap-4">
                                    <div className="space-y-2 flex-1">
                                        <label className="text-xs font-bold text-zinc-400 uppercase ml-1">速度</label>
                                        <div className="relative">
                                            <input type="number" value={speed} onChange={e=>setSpeed(e.target.value)} placeholder="5.0" className="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-4 text-white font-bold text-lg outline-none focus:border-primary/50" />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold">KM/H</span>
                                        </div>
                                    </div>
                                    <div className="space-y-2 flex-1">
                                        <label className="text-xs font-bold text-zinc-400 uppercase ml-1">坡度</label>
                                        <div className="relative">
                                            <input type="number" value={incline} onChange={e=>setIncline(e.target.value)} placeholder="0" className="w-full bg-black/40 border border-white/10 rounded-xl py-4 px-4 text-white font-bold text-lg outline-none focus:border-primary/50" />
                                            <span className="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold">%</span>
                                        </div>
                                    </div>
                                </div>

                                <button onClick={calculate} className="w-full py-4 bg-white text-black font-bold rounded-xl text-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                                    <Icon name="calculator" size={20} /> 计算消耗
                                </button>
                            </div>

                            {/* 结果展示 */}
                            {result !== null && (
                                <div className="bg-gradient-to-br from-orange/20 to-black border border-orange/30 rounded-3xl p-8 text-center relative overflow-hidden animate-slide-up">
                                    <div className="relative z-10">
                                        <div className="text-zinc-400 text-xs font-bold uppercase tracking-widest mb-2">Estimated Burn</div>
                                        <div className="text-6xl font-black text-white italic tracking-tighter text-glow">
                                            {result}
                                        </div>
                                        <div className="text-orange font-bold mt-1">KCAL</div>
                                        <p className="text-xs text-zinc-500 mt-4 px-4">基于 ACSM 权威公式 • 体重 {appData.userStats.weight || 70}kg</p>
                                        
                                        {/* 新增记录按钮 */}
                                        <button onClick={saveRecord} className="mt-6 w-full py-3 bg-accent text-white font-bold rounded-xl text-sm shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                                            <Icon name="save" size={18} /> 记录
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // --- 底部导航栏 ---
            const BottomNav = () => (
                <div className="fixed bottom-0 left-0 right-0 nav-glass pb-safe pt-2 px-6 flex justify-around border-t border-white/10 z-20">
                    <button onClick={()=>setView('templates')} className={`flex flex-col items-center p-2 w-16 transition-colors ${view==='templates'?'text-white':'text-zinc-600'}`}>
                        <Icon name="layout-list" size={24} strokeWidth={2.5} />
                        <span className="text-[10px] font-bold mt-1">计划</span>
                    </button>
                    <button onClick={()=>setView('cardio')} className={`flex flex-col items-center p-2 w-16 transition-colors ${view==='cardio'?'text-white':'text-zinc-600'}`}>
                        {view==='cardio' && <div className="absolute -top-2 w-8 h-8 bg-orange/30 blur-lg rounded-full"></div>}
                        <Icon name="heart-pulse" size={24} strokeWidth={2.5} />
                        <span className="text-[10px] font-bold mt-1">有氧</span>
                    </button>
                    <button onClick={()=>setView('me')} className={`flex flex-col items-center p-2 w-16 transition-colors ${view==='me'?'text-white':'text-zinc-600'}`}>
                        {view==='me' && <div className="absolute -top-2 w-8 h-8 bg-primary/30 blur-lg rounded-full"></div>}
                        <Icon name="user" size={24} strokeWidth={2.5} />
                        <span className="text-[10px] font-bold mt-1">我的</span>
                    </button>
                </div>
            );

            // --- 路由: 页面渲染 ---
            if (isCreatingTemplate) {
                 return (
                    /* 新建计划页面 */
                    <div className="min-h-screen pb-safe flex flex-col animate-slide-up bg-background relative">
                        <BackgroundGlow />
                        <div className="header-spacing px-4 border-b border-white/10 flex justify-between items-center nav-glass sticky top-0 z-10">
                            <button onClick={() => setIsCreatingTemplate(false)} className="text-zinc-400 text-sm font-medium">取消</button>
                            <span className="font-bold text-white flex items-center gap-2">新计划</span>
                            <button onClick={() => {
                                if(!newTemplateName) return alert('请输入名称');
                                setAppData(prev => ({...prev, templates: [...prev.templates, {id: Date.now(), name: newTemplateName, exercises: newTemplateExercises.map(e=>e.id)}]}));
                                setIsCreatingTemplate(false); setNewTemplateName(''); setNewTemplateExercises([]);
                            }} className="text-primary font-bold text-sm bg-primary/10 px-3 py-1 rounded-full">保存</button>
                        </div>
                        <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-4 backdrop-blur-md">
                                <input value={newTemplateName} onChange={e => setNewTemplateName(e.target.value)} placeholder="计划名称 (例如: 胸肌训练 A)" className="w-full bg-transparent text-xl font-bold text-white outline-none placeholder-zinc-600" autoFocus />
                            </div>
                            <div>
                                <div className="text-xs text-zinc-400 font-bold uppercase mb-3 ml-2 tracking-wider">动作编排</div>
                                <div className="space-y-2">
                                    {newTemplateExercises.map((ex, i) => (
                                        <div key={i} className="p-4 bg-card-gradient border border-white/5 rounded-2xl flex justify-between items-center">
                                            <span className="text-white font-medium">{ex.name}</span>
                                            <button onClick={() => setNewTemplateExercises(prev => prev.filter((_, idx) => idx !== i))} className="text-danger/80 hover:text-danger"><Icon name="minus-circle" size={20}/></button>
                                        </div>
                                    ))}
                                    <button onClick={() => setShowExerciseSelector(true)} className="w-full py-4 bg-white/5 border border-white/10 border-dashed rounded-2xl text-primary font-bold flex items-center justify-center gap-2 active:scale-[0.98] transition-all hover:bg-white/10"><Icon name="plus" size={18} /> 添加动作</button>
                                </div>
                            </div>
                        </div>
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            if (view === 'workout') {
                /* 训练页面 */
                return (
                    <div className="min-h-screen bg-black pb-safe relative">
                        <BackgroundGlow />
                        <div className="sticky top-0 z-30 pt-safe pb-4 px-4 bg-gradient-to-b from-black via-black/90 to-transparent pointer-events-none flex justify-center">
                            <div className="pointer-events-auto bg-surface/80 backdrop-blur-xl border border-white/10 rounded-full pl-1 pr-1 py-1 flex items-center shadow-[0_8px_32px_rgba(0,0,0,0.5)] animate-fade-in">
                                <button onClick={() => setView('templates')} className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-zinc-400 mr-3"><Icon name="chevron-down" size={18} /></button>
                                <div className="font-mono text-white font-bold text-lg tracking-wider w-24 text-center text-glow">{durationStr}</div>
                                <button onClick={finishWorkout} className="ml-3 px-4 py-1.5 bg-primary hover:bg-primary/90 text-white text-xs font-bold rounded-full transition-colors">完成</button>
                            </div>
                        </div>
                        <div className="p-4 space-y-8 pb-32">
                            {activeWorkoutData.exercises.map((ex, exIndex) => (
                                <div key={exIndex} className="bg-card-gradient backdrop-blur-md rounded-3xl p-5 border border-white/5 shadow-lg relative overflow-hidden group">
                                    <div className="flex justify-between items-center mb-6 relative z-10">
                                        <h3 className="text-xl font-black text-white flex gap-2 items-center italic">{ex.name} {ex.instructions && <button onClick={()=>setExerciseDetails(ex)} className="text-primary/80"><Icon name="info" size={18}/></button>}</h3>
                                    </div>
                                    <div className="space-y-3 relative z-10">
                                        <div className="grid grid-cols-[30px_1fr_1fr_1fr_30px_30px] gap-2 text-[10px] text-zinc-500 font-bold uppercase tracking-wider text-center mb-2 px-1"><div>Set</div><div>KG</div><div>Reps</div><div>RPE</div><div></div><div></div></div>
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={set.id} className={`grid grid-cols-[30px_1fr_1fr_1fr_30px_30px] gap-2 items-center transition-all duration-300 ${set.completed ? 'opacity-40 grayscale' : ''}`}>
                                                <div className="text-zinc-500 text-sm font-mono font-bold text-center">{sIdx+1}</div>
                                                <input value={set.weight} onChange={(e) => {const newExs=[...activeWorkoutData.exercises];newExs[exIndex].sets[sIdx].weight=e.target.value;setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} placeholder="-" className="bg-black/40 rounded-lg py-2 text-center text-white font-bold text-lg border border-white/5 outline-none focus:border-primary/50 focus:bg-white/5 transition-all" type="number" inputMode="decimal" />
                                                <input value={set.reps} onChange={(e) => {const newExs=[...activeWorkoutData.exercises];newExs[exIndex].sets[sIdx].reps=e.target.value;setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} placeholder="-" className="bg-black/40 rounded-lg py-2 text-center text-white font-bold text-lg border border-white/5 outline-none focus:border-primary/50 focus:bg-white/5 transition-all" type="number" inputMode="decimal" />
                                                <input value={set.rpe} onChange={(e) => {const newExs=[...activeWorkoutData.exercises];newExs[exIndex].sets[sIdx].rpe=e.target.value;setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} placeholder="-" className="bg-black/40 rounded-lg py-2 text-center text-zinc-400 font-bold text-lg border border-white/5 outline-none focus:border-primary/50 focus:bg-white/5 transition-all" type="number" inputMode="decimal" />
                                                <button onClick={()=>{const newExs=[...activeWorkoutData.exercises];newExs[exIndex].sets[sIdx].completed=!newExs[exIndex].sets[sIdx].completed;setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} className={`h-10 w-full rounded-lg flex items-center justify-center transition-all ${set.completed ? 'bg-primary text-white shadow-glow' : 'bg-white/5 text-zinc-600'}`}><Icon name="check" size={16} strokeWidth={4} /></button>
                                                <button onClick={()=>{const newExs=[...activeWorkoutData.exercises];newExs[exIndex].sets=newExs[exIndex].sets.filter((_,idx)=>idx!==sIdx);setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} className="h-10 w-full flex items-center justify-center text-zinc-700 hover:text-danger transition-colors"><Icon name="trash-2" size={16} /></button>
                                            </div>
                                        ))}
                                        <button onClick={() => {const newExs=[...activeWorkoutData.exercises];const prev=newExs[exIndex].sets[newExs[exIndex].sets.length-1];newExs[exIndex].sets.push({id:Date.now(),weight:prev?prev.weight:'',reps:prev?prev.reps:'',rpe:'',completed:false});setActiveWorkoutData({...activeWorkoutData,exercises:newExs})}} className="w-full py-3 mt-4 rounded-xl border border-dashed border-white/10 text-zinc-500 text-sm font-bold hover:text-white hover:border-white/20 transition-all flex items-center justify-center gap-2"><Icon name="plus" size={14} /> 加一组</button>
                                    </div>
                                </div>
                            ))}
                            <button onClick={() => setShowExerciseSelector(true)} className="w-full py-5 rounded-3xl bg-surfaceHighlight/50 border border-white/5 text-white/50 font-bold text-lg flex items-center justify-center gap-2 active:scale-98 transition-transform"><Icon name="plus-circle" size={24} /> 添加新动作</button>
                        </div>
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            if (view === 'cardio') return (<><CardioView /><BottomNav /></>);
            if (view === 'me') {
                // 将 MeView 的逻辑直接移入主渲染流程，避免组件重绘导致输入框失焦
                const muscles = ['CHEST', 'BACK', 'LEGS', 'SHOULDERS', 'ARMS', 'ABS'];
                const now = Date.now();
                
                const getRecoveryStatus = (muscle) => {
                    const recoveryTimeStr = appData.userStats.muscleRecovery[muscle];
                    if (!recoveryTimeStr) return { percent: 100, label: 'Ready' };
                    
                    const recoveryTime = new Date(recoveryTimeStr).getTime();
                    if (now > recoveryTime) return { percent: 100, label: 'Ready' };
                    
                    const timeLeft = recoveryTime - now;
                    const hoursLeft = Math.ceil(timeLeft / (3600 * 1000));
                    let p = 100 - (hoursLeft / 72 * 100); 
                    if (p < 0) p = 0;
                    return { percent: Math.round(p), label: `${hoursLeft}h left` };
                };

                const saveStats = (key, val) => {
                    setAppData(prev => ({
                        ...prev, userStats: { ...prev.userStats, [key]: val }
                    }));
                };
                
                const h = parseFloat(appData.userStats.height) / 100;
                const w = parseFloat(appData.userStats.weight);
                const bmi = (h && w) ? (w / (h*h)).toFixed(1) : '--';

                return (
                    <div className="min-h-screen bg-background pb-24 relative animate-fade-in">
                        <BackgroundGlow />
                        <div className="header-spacing px-6 border-b border-white/5 nav-glass sticky top-0 z-20 flex justify-between items-center">
                            <h1 className="text-2xl font-black text-white italic">PROFILE</h1>
                            <div className="px-3 py-1 rounded-full border border-white/10 bg-white/5 text-xs font-mono text-zinc-400">BMI {bmi}</div>
                        </div>

                        <div className="p-6 space-y-8">
                            <div className="bg-card-gradient border border-white/10 rounded-3xl p-6 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-10"><Icon name="ruler" size={100} /></div>
                                <h3 className="text-white font-bold text-lg mb-6 flex items-center gap-2"><Icon name="user-cog" size={18} className="text-primary"/> 身体参数</h3>
                                <div className="flex gap-6 relative z-10">
                                    <div className="flex-1 space-y-2">
                                        <label className="text-xs font-bold text-zinc-500 uppercase">Height (CM)</label>
                                        <input type="number" value={appData.userStats.height || ''} onChange={e=>saveStats('height', e.target.value)} placeholder="175" className="w-full bg-black/50 border border-white/10 rounded-xl py-3 px-4 text-white font-bold text-xl outline-none focus:border-primary transition-colors text-center" />
                                    </div>
                                    <div className="flex-1 space-y-2">
                                        <label className="text-xs font-bold text-zinc-500 uppercase">Weight (KG)</label>
                                        <input type="number" value={appData.userStats.weight || ''} onChange={e=>saveStats('weight', e.target.value)} placeholder="70" className="w-full bg-black/50 border border-white/10 rounded-xl py-3 px-4 text-white font-bold text-xl outline-none focus:border-primary transition-colors text-center" />
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h3 className="text-white font-bold text-lg mb-4 flex items-center gap-2 px-2"><Icon name="activity" size={18} className="text-accent"/> 恢复状态 (Matrix)</h3>
                                <div className="grid grid-cols-2 gap-3">
                                    {muscles.map(m => {
                                        const status = getRecoveryStatus(m);
                                        const isReady = status.percent === 100;
                                        return (
                                            <div key={m} className={`p-4 rounded-2xl border ${isReady ? 'bg-surfaceHighlight/30 border-white/5' : 'bg-surfaceHighlight border-white/10'} transition-all`}>
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold text-zinc-400">{m}</span>
                                                    {isReady ? <Icon name="check-circle" size={14} className="text-accent"/> : <span className="text-[10px] text-orange font-mono">{status.label}</span>}
                                                </div>
                                                <div className="h-1.5 w-full bg-black/50 rounded-full overflow-hidden">
                                                    <div className={`h-full rounded-full transition-all duration-1000 ${isReady ? 'bg-accent' : 'bg-orange'}`} style={{width: `${status.percent}%`}}></div>
                                                </div>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-surfaceHighlight rounded-2xl p-5 border border-white/5 flex flex-col items-center justify-center text-center">
                                    <div className="text-primary mb-2 opacity-80"><Icon name="dumbbell" size={28}/></div>
                                    <div className="text-2xl font-black text-white font-mono tracking-tight">{appData.userStats.totalWorkouts || 0}</div>
                                    <div className="text-[10px] font-bold text-zinc-500 uppercase mt-1">Total Workouts</div>
                                </div>
                                <div className="bg-surfaceHighlight rounded-2xl p-5 border border-white/5 flex flex-col items-center justify-center text-center">
                                    <div className="text-accent mb-2 opacity-80"><Icon name="layers" size={28}/></div>
                                    <div className="text-2xl font-black text-white font-mono tracking-tight">{(appData.userStats.totalVolume / 1000).toFixed(1)}k</div>
                                    <div className="text-[10px] font-bold text-zinc-500 uppercase mt-1">Volume (Ton)</div>
                                </div>
                            </div>
                        </div>
                        <BottomNav />
                    </div>
                );
            }

            // 默认 Templates View
            return (
                <div className="min-h-screen bg-transparent pb-24 relative">
                    <BackgroundGlow />
                    <div className="header-spacing px-6 flex justify-between items-center nav-glass sticky top-0 z-20">
                        <div className="flex items-center gap-2"><GeminiStar size={28} className="animate-pulse-slow" /><h1 className="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-white/70">IRON</h1></div>
                        <button onClick={() => setIsSettingsOpen(true)} className="text-white/80 font-medium text-sm bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-md border border-white/5">数据</button>
                    </div>

                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-md flex items-end sm:items-center justify-center animate-fade-in" onClick={() => setIsSettingsOpen(false)}>
                            <div className="bg-surface/90 backdrop-blur-xl w-full max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-white/10 p-6 space-y-6 pb-safe relative overflow-hidden" onClick={e=>e.stopPropagation()}>
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-accent"></div>
                                <div className="flex justify-between items-center"><h2 className="text-xl font-bold text-white">设置</h2><button onClick={() => setIsSettingsOpen(false)} className="text-white bg-white/10 rounded-full p-1"><Icon name="x" size={18}/></button></div>
                                <div className="space-y-3">
                                    <button onClick={handleExport} className="w-full py-4 bg-white/5 border border-white/5 rounded-2xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform"><div className="bg-primary/20 p-2 rounded-xl text-primary"><Icon name="download" size={20} /></div><span className="flex-1 text-left">备份数据</span></button>
                                    <label className="w-full py-4 bg-white/5 border border-white/5 rounded-2xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform cursor-pointer"><div className="bg-accent/20 p-2 rounded-xl text-accent"><Icon name="upload" size={20} /></div><span className="flex-1 text-left">恢复数据</span><input type="file" accept=".json" onChange={handleImport} className="hidden" /></label>
                                </div>
                                <div className="mt-4 pt-4 border-t border-white/5 text-xs text-zinc-500 text-center space-y-1">
                                    <p>已经链接动作库：{fullLibrary.length} 个动作</p>
                                    <p>IRON 版本：v8.1</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="px-4 mt-6 space-y-4">
                        {appData.templates.length === 0 ? (
                            <div className="py-24 text-center relative">
                                <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-primary/20 rounded-full blur-[60px] pointer-events-none"></div>
                                <div className="w-20 h-20 bg-gradient-to-br from-surfaceHighlight to-black rounded-3xl border border-white/10 flex items-center justify-center mx-auto mb-6 text-zinc-500 shadow-2xl relative z-10 animate-float"><GeminiStar size={40} /></div>
                                <h3 className="text-white font-bold text-xl relative z-10">开启训练之旅</h3>
                                <p className="text-zinc-500 text-sm mt-2 mb-10 relative z-10">创建属于你的第一个训练计划</p>
                                <button onClick={() => setIsCreatingTemplate(true)} className="relative z-10 bg-white text-black px-10 py-4 rounded-full font-bold text-sm shadow-[0_0_20px_rgba(255,255,255,0.3)] active:scale-95 transition-transform">新建计划</button>
                            </div>
                        ) : (
                            appData.templates.map(t => (
                                <div key={t.id} onClick={() => startWorkout(t.exercises)} className="group bg-card-gradient backdrop-blur-sm border border-white/5 rounded-2xl p-5 flex justify-between items-center active:scale-[0.99] transition-all cursor-pointer shadow-lg hover:shadow-[0_0_20px_rgba(255,255,255,0.05)]">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-black flex items-center justify-center border border-white/5 text-primary group-hover:text-white transition-colors"><span className="font-mono font-bold text-lg">{t.name.charAt(0).toUpperCase()}</span></div>
                                        <div><h3 className="text-lg font-bold text-white group-hover:text-primary transition-colors">{t.name}</h3><p className="text-xs text-zinc-500 mt-1 font-mono">{t.exercises.length} MOVES</p></div>
                                    </div>
                                    <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-zinc-500 group-hover:bg-primary group-hover:text-white transition-all"><Icon name="play" size={14} className="ml-0.5" fill="currentColor" /></div>
                                </div>
                            ))
                        )}
                        {appData.templates.length > 0 && (<button onClick={() => setIsCreatingTemplate(true)} className="w-full py-4 bg-white/5 border border-white/5 text-white/70 font-bold rounded-2xl mt-4 active:scale-98 transition-transform hover:bg-white/10 flex items-center justify-center gap-2"><Icon name="plus" size={18} /> 新建计划</button>)}
                    </div>
                    <BottomNav />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
