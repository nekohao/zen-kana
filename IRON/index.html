<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IRON</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#000000', 
                        surface: '#1c1c1e', 
                        surfaceHighlight: '#2c2c2e',
                        primary: '#0a84ff', 
                        accent: '#30d158',
                        danger: '#ff453a', 
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    },
                    backgroundImage: {
                        'gemini-gradient': 'linear-gradient(to bottom right, #1e3a8a, #000000, #000000)',
                        'card-gradient': 'linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)',
                    }
                }
            }
        }
    </script>
    <style>
        /* 全局样式重置 */
        body { 
            background-color: #000000;
            color: #f2f2f7; 
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "ss01", "ss02"; 
            /* 允许背景透出 */
            background-image: radial-gradient(circle at 50% 0%, rgba(10, 132, 255, 0.15), transparent 40%),
                              radial-gradient(circle at 80% 20%, rgba(50, 215, 75, 0.05), transparent 30%);
            background-attachment: fixed;
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 优化的毛玻璃效果 */
        .glass {
            background: rgba(20, 20, 22, 0.7);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* 头部导航专用玻璃 */
        .nav-glass {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* 针对 Header 的特殊修正：确保不挡住状态栏 */
        .header-spacing {
            padding-top: calc(env(safe-area-inset-top) + 12px); 
            padding-bottom: 16px;
        }
    </style>
</head>
<body class="h-full selection:bg-primary selection:text-white">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 0. 美化组件 ---
        
        // Gemini 风格的星光图标
        const GeminiStar = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
                <path d="M12 0C12 6.62742 17.3726 12 24 12C17.3726 12 12 17.3726 12 24C12 17.3726 6.62742 12 0 12C6.62742 12 12 6.62742 12 0Z" fill="url(#paint0_linear)"/>
                <defs>
                    <linearGradient id="paint0_linear" x1="12" y1="0" x2="12" y2="24" gradientUnits="userSpaceOnUse">
                        <stop stopColor="#30d158"/>
                        <stop offset="0.5" stopColor="#0a84ff"/>
                        <stop offset="1" stopColor="#5e5ce6"/>
                    </linearGradient>
                </defs>
            </svg>
        );

        // 背景装饰光效
        const BackgroundGlow = () => (
            <div className="fixed inset-0 pointer-events-none z-[-1] overflow-hidden">
                <div className="absolute top-[-100px] left-[-50px] w-64 h-64 bg-primary/20 rounded-full blur-[80px] opacity-40 animate-pulse-slow"></div>
                <div className="absolute bottom-[20%] right-[-50px] w-72 h-72 bg-accent/10 rounded-full blur-[80px] opacity-30"></div>
            </div>
        );

        // --- 1. 数据模型与存储 ---
        const STORAGE_KEY = 'iron_app_data_v6_clean';
        const initialData = {
            templates: [],        
            customExercises: [],  
            history: {},          
            importedLibrary: []   
        };

        const useStorage = () => {
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : initialData;
                } catch (e) { return initialData; }
            });
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);
            return [data, setData];
        };

        // --- 2. 外部 JSON 库解析器 ---
        const useExternalLibrary = (setAppData) => {
            useEffect(() => {
                const fetchLibrary = async () => {
                    try {
                        const response = await fetch('./exercise_library.json');
                        if (!response.ok) throw new Error('网络响应错误');
                        const json = await response.json();
                        const parseRecursive = (obj, contextKey = '') => {
                            let extracted = [];
                            if (Array.isArray(obj)) {
                                return obj.map(ex => {
                                    const combinedMuscles = [
                                        ...(ex.muscle_group || []),
                                        ...(ex.primary_muscle || []),
                                        ...(ex.secondary_muscle || [])
                                    ];
                                    const catSource = combinedMuscles.length > 0 ? combinedMuscles : [contextKey];
                                    return {
                                        id: `ext_${(ex.id || ex.name).replace(/\s+/g, '')}_${Math.random().toString(36).substr(2,5)}`,
                                        name: ex.name,
                                        category: normalizeCategory(catSource), 
                                        muscles: normalizeMuscles(combinedMuscles), 
                                        rawMuscles: ex.primary_muscle || ex.muscle_group, 
                                        instructions: ex.instructions || ex.cues,
                                        mistakes: ex.common_mistakes || ex.common_mistakes
                                    };
                                });
                            }
                            if (typeof obj === 'object' && obj !== null) {
                                Object.keys(obj).forEach(key => {
                                    if (key === 'version') return; 
                                    extracted = [...extracted, ...parseRecursive(obj[key], key)];
                                });
                            }
                            return extracted;
                        };
                        const exercises = parseRecursive(json);
                        if (exercises.length > 0) {
                            setAppData(prev => ({ ...prev, importedLibrary: exercises }));
                        }
                    } catch (error) { console.log("加载外部库失败:", error); }
                };
                fetchLibrary();
            }, []);
        };

        const normalizeCategory = (input) => {
            const str = JSON.stringify(input).toLowerCase();
            if (str.includes('chest') || str.includes('胸')) return 'CHEST';
            if (str.includes('back') || str.includes('背') || str.includes('lats')) return 'BACK';
            if (str.includes('leg') || str.includes('腿') || str.includes('squat') || str.includes('quad')) return 'LEGS';
            if (str.includes('glute') || str.includes('臀')) return 'GLUTES';
            if (str.includes('shoulder') || str.includes('delt') || str.includes('肩')) return 'SHOULDERS';
            if (str.includes('arm') || str.includes('biceps') || str.includes('triceps') || str.includes('臂') || str.includes('二头') || str.includes('三头')) return 'ARMS';
            return 'CORE';
        };

        const normalizeMuscles = (input) => {
            const muscleMap = {
                '胸': 'chest_major', 'chest': 'chest_major', 'pec': 'chest_major',
                '背': 'lats', 'lat': 'lats', 'traps': 'traps_upper',
                '腿': 'quads', 'quad': 'quads', 'hamstring': 'hamstrings', 'calf': 'calves', 'calves': 'calves',
                '臀': 'glutes', 'glute': 'glutes',
                '肩': 'delt_front', 'delt': 'delt_side', 'shoulder': 'delt_side',
                '二头': 'biceps', 'bicep': 'biceps', '三头': 'triceps', 'tricep': 'triceps',
                '腹': 'abs', 'abs': 'abs', 'core': 'abs'
            };
            const str = JSON.stringify(input).toLowerCase();
            const result = [];
            Object.keys(muscleMap).forEach(key => {
                if (str.includes(key)) result.push(muscleMap[key]);
            });
            return result.length > 0 ? result : ['body'];
        };

        // --- 3. UI 组件 ---
        
        const Icon = ({ name, size = 20, className, strokeWidth = 2, onClick }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                     lucide.createIcons({
                        icons: { [name]: iconRef.current },
                        attrs: { 'stroke-width': strokeWidth, width: size, height: size, class: className }
                    });
                }
            }, [name, size, className, strokeWidth]);
            return <i ref={iconRef} data-lucide={name} onClick={onClick}></i>;
        };

        const BodyMap = ({ activeMuscles = [], className = "" }) => {
            const getStyle = (pathId) => {
                const isHit = activeMuscles.some(m => pathId.toLowerCase().includes(m.split('_')[0]));
                return isHit ? "fill-primary filter drop-shadow-[0_0_3px_rgba(10,132,255,0.5)]" : "fill-white/10 stroke-white/20 stroke-[0.5]";
            };

            return (
                <svg viewBox="0 0 400 600" xmlns="http://www.w3.org/2000/svg" className={className}>
                    <g id="body_outline">
                        <path d="M200,30 Q230,30 240,70 Q240,100 220,130 L180,130 Q160,100 160,70 Q170,30 200,30" className="fill-white/5 stroke-white/10" />
                        <path id="traps" d="M160,80 Q140,90 130,120 L150,130 L250,130 L270,120 Q260,90 240,80 Z" className={getStyle('traps')} />
                        <path id="chest" d="M145,130 L255,130 Q265,180 200,210 Q135,180 145,130 Z" className={getStyle('chest')} />
                        <path id="delts" d="M130,120 Q100,130 100,160 L135,170 L145,130 M270,120 Q300,130 300,160 L265,170 L255,130" className={getStyle('delt')} />
                        <path id="arms" d="M135,170 L100,160 L90,280 L130,280 L135,170 M265,170 L300,160 L310,280 L270,280 L265,170" className={getStyle('biceps')} />
                        <path id="abs" d="M160,210 L240,210 L230,320 L170,320 Z" className={getStyle('abs')} />
                        <path id="lats" d="M145,180 L135,260 L160,280 M255,180 L265,260 L240,280" className={getStyle('lats')} />
                        <path id="legs" d="M170,320 L140,330 L150,550 L180,550 L190,340 M230,320 L260,330 L250,550 L220,550 L210,340" className={getStyle('quads')} />
                    </g>
                </svg>
            );
        };

        // --- 4. 主程序入口 ---
        const App = () => {
            const [appData, setAppData] = useStorage();
            useExternalLibrary(setAppData); 

            const [view, setView] = useState('templates');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [newTemplateExercises, setNewTemplateExercises] = useState([]);
            
            const [showExerciseSelector, setShowExerciseSelector] = useState(false);
            const [exerciseDetails, setExerciseDetails] = useState(null); 

            const [activeWorkoutData, setActiveWorkoutData] = useState({ exercises: [], startTime: null, endTime: null });
            const [durationStr, setDurationStr] = useState("00:00");

            const fullLibrary = useMemo(() => {
                return [...appData.importedLibrary, ...appData.customExercises];
            }, [appData.importedLibrary, appData.customExercises]);

            const getExerciseById = useCallback((id) => {
                return fullLibrary.find(ex => ex.id === id) || { id, name: '未知动作', muscles: [], category: 'CORE' };
            }, [fullLibrary]);

            // --- 核心业务逻辑 ---
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iron_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm("恢复数据会覆盖现有记录，确认吗？")) {
                            setAppData(imported);
                            alert("恢复成功");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("文件格式错误"); }
                };
                reader.readAsText(file);
            };

            const startWorkout = (exercises = []) => {
                const exObjects = exercises.map(exId => {
                    const ex = getExerciseById(exId);
                    return { ...ex, sets: [{ id: Date.now(), weight: '', reps: '', rpe: '', completed: false }] };
                });
                setActiveWorkoutData({ exercises: exObjects, startTime: new Date(), endTime: null });
                setView('workout');
            };

            useEffect(() => {
                if (!activeWorkoutData.startTime || activeWorkoutData.endTime) return;
                const timer = setInterval(() => {
                    const diff = Math.floor((new Date() - activeWorkoutData.startTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    setDurationStr(`${m}:${s < 10 ? '0' : ''}${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [activeWorkoutData.startTime, activeWorkoutData.endTime]);

            // --- 子组件 ---

            const ExerciseSelector = () => {
                const [filter, setFilter] = useState('CHEST');
                const categories = [
                    { id: 'CHEST', name: '胸部' }, { id: 'BACK', name: '背部' },
                    { id: 'LEGS', name: '腿部' }, { id: 'SHOULDERS', name: '肩部' },
                    { id: 'ARMS', name: '手臂' }, { id: 'GLUTES', name: '臀部' },
                    { id: 'CORE', name: '核心' },
                ];
                const list = fullLibrary.filter(ex => ex.category === filter);

                return (
                    <div className="fixed inset-0 z-50 bg-black/95 backdrop-blur-xl flex flex-col animate-slide-up">
                        <div className="header-spacing px-4 flex justify-between items-center bg-black/50 border-b border-white/10">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2">
                                <GeminiStar size={20} />
                                动作库
                            </h2>
                            <button onClick={() => setShowExerciseSelector(false)} className="text-primary font-medium">关闭</button>
                        </div>
                        <div className="p-4 flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {categories.map(c => (
                                <button key={c.id} onClick={() => setFilter(c.id)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${filter === c.id ? 'bg-white text-black border-white shadow-[0_0_10px_rgba(255,255,255,0.3)]' : 'bg-surfaceHighlight text-zinc-400 border-transparent'}`}>
                                    {c.name}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto px-4 pb-safe space-y-3">
                            {list.map(ex => (
                                <div key={ex.id} className="p-4 bg-card-gradient border border-white/5 rounded-2xl flex justify-between items-center active:scale-[0.99] transition-transform" 
                                     onClick={() => {
                                         if(isCreatingTemplate) setNewTemplateExercises(prev => [...prev, ex]);
                                         else if(activeWorkoutData.startTime) setActiveWorkoutData(prev => ({...prev, exercises: [...prev.exercises, {...ex, sets:[{id:Date.now(), weight:'', reps:'', completed:false}]}]}));
                                         setShowExerciseSelector(false);
                                     }}>
                                    <div>
                                        <div className="text-white font-medium">{ex.name}</div>
                                        <div className="text-xs text-zinc-500 mt-0.5">{ex.rawMuscles ? ex.rawMuscles.join(' · ') : ex.category}</div>
                                    </div>
                                    <div className="flex gap-4 items-center">
                                        {(ex.instructions) && <button onClick={(e)=>{e.stopPropagation(); setExerciseDetails(ex)}} className="text-primary"><Icon name="info" size={20}/></button>}
                                        <span className="text-xs font-bold text-black bg-white px-3 py-1 rounded-full">添加</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const ExerciseInfoModal = () => {
                if (!exerciseDetails) return null;
                return (
                    <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-md flex items-center justify-center p-6 animate-fade-in" onClick={() => setExerciseDetails(null)}>
                        <div className="bg-surface w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl border border-white/10 relative" onClick={e=>e.stopPropagation()}>
                            {/* 弹窗背景光效 */}
                            <div className="absolute top-0 right-0 w-32 h-32 bg-primary/20 blur-[50px] pointer-events-none"></div>

                            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5 backdrop-blur-sm relative z-10">
                                <h3 className="text-white font-bold flex items-center gap-2"><GeminiStar size={16} />{exerciseDetails.name}</h3>
                                <button onClick={() => setExerciseDetails(null)} className="text-zinc-400"><Icon name="x" size={20}/></button>
                            </div>
                            <div className="p-5 space-y-5 max-h-[60vh] overflow-y-auto relative z-10">
                                <div>
                                    <div className="text-primary text-xs font-bold uppercase mb-2 tracking-wider">动作指导</div>
                                    <ul className="list-none text-sm text-zinc-300 space-y-2 leading-relaxed">
                                        {exerciseDetails.instructions?.map((i,idx)=><li key={idx} className="flex gap-2"><span className="text-primary">•</span><span>{i}</span></li>) || <li>暂无说明</li>}
                                    </ul>
                                </div>
                                {exerciseDetails.mistakes && (
                                    <div>
                                        <div className="text-danger text-xs font-bold uppercase mb-2 tracking-wider">常见错误</div>
                                        <ul className="list-none text-sm text-zinc-300 space-y-2 leading-relaxed">
                                            {exerciseDetails.mistakes.map((m,idx)=><li key={idx} className="flex gap-2"><span className="text-danger">•</span><span>{m}</span></li>)}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- 5. 视图路由 ---

            // 新建计划
            if (isCreatingTemplate) {
                return (
                    <div className="min-h-screen pb-safe flex flex-col animate-slide-up bg-background relative">
                        <BackgroundGlow />
                        <div className="header-spacing px-4 border-b border-white/10 flex justify-between items-center nav-glass sticky top-0 z-10">
                            <button onClick={() => setIsCreatingTemplate(false)} className="text-zinc-400 text-sm font-medium">取消</button>
                            <span className="font-bold text-white flex items-center gap-2">新计划</span>
                            <button onClick={() => {
                                if(!newTemplateName) return alert('请输入名称');
                                setAppData(prev => ({...prev, templates: [...prev.templates, {id: Date.now(), name: newTemplateName, exercises: newTemplateExercises.map(e=>e.id)}]}));
                                setIsCreatingTemplate(false); setNewTemplateName(''); setNewTemplateExercises([]);
                            }} className="text-primary font-bold text-sm bg-primary/10 px-3 py-1 rounded-full">保存</button>
                        </div>
                        
                        <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                            <div className="bg-white/5 border border-white/10 rounded-2xl p-4 backdrop-blur-md">
                                <input value={newTemplateName} onChange={e => setNewTemplateName(e.target.value)} placeholder="计划名称 (例如: 胸肌训练 A)" className="w-full bg-transparent text-xl font-bold text-white outline-none placeholder-zinc-600" autoFocus />
                            </div>
                            
                            <div>
                                <div className="text-xs text-zinc-400 font-bold uppercase mb-3 ml-2 tracking-wider">动作编排</div>
                                <div className="space-y-2">
                                    {newTemplateExercises.map((ex, i) => (
                                        <div key={i} className="p-4 bg-card-gradient border border-white/5 rounded-2xl flex justify-between items-center">
                                            <span className="text-white font-medium">{ex.name}</span>
                                            <button onClick={() => setNewTemplateExercises(prev => prev.filter((_, idx) => idx !== i))} className="text-danger/80 hover:text-danger"><Icon name="minus-circle" size={20}/></button>
                                        </div>
                                    ))}
                                    <button onClick={() => setShowExerciseSelector(true)} className="w-full py-4 bg-white/5 border border-white/10 border-dashed rounded-2xl text-primary font-bold flex items-center justify-center gap-2 active:scale-[0.98] transition-all hover:bg-white/10">
                                        <Icon name="plus" size={18} /> 添加动作
                                    </button>
                                </div>
                            </div>
                        </div>
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            // 正在训练
            if (view === 'workout') {
                return (
                    <div className="min-h-screen bg-black pb-safe relative">
                         <div className="fixed inset-0 pointer-events-none z-[0]">
                            <div className="absolute top-0 right-0 w-full h-[300px] bg-gradient-to-b from-primary/10 to-transparent"></div>
                        </div>
                        <div className="sticky top-0 z-30 header-spacing bg-black/80 backdrop-blur-md border-b border-white/10 px-4 flex justify-between items-center">
                            <button onClick={() => setView('templates')} className="text-zinc-400"><Icon name="chevron-down" size={24} /></button>
                            <span className="font-mono text-white font-bold tabular-nums text-xl tracking-wider text-shadow-glow">{durationStr}</span>
                            <button className="bg-white text-black text-xs font-bold px-4 py-1.5 rounded-full shadow-lg" onClick={() => setView('templates')}>完成</button>
                        </div>
                        <div className="p-4 space-y-6 relative z-10">
                            {activeWorkoutData.exercises.map((ex, i) => (
                                <div key={i} className="bg-card-gradient backdrop-blur-md rounded-3xl p-5 border border-white/10 shadow-lg">
                                    <div className="flex justify-between items-center mb-5 border-b border-white/5 pb-3">
                                        <h3 className="text-lg font-bold text-white flex gap-2 items-center">
                                            {ex.name}
                                            {ex.instructions && <button onClick={()=>setExerciseDetails(ex)} className="text-primary/80"><Icon name="info" size={18}/></button>}
                                        </h3>
                                    </div>
                                    <div className="space-y-3">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className={`grid grid-cols-[24px_1fr_1fr_1fr_44px] gap-3 items-center ${set.completed ? 'opacity-40 grayscale' : ''} transition-all duration-300`}>
                                                <span className="text-zinc-600 text-xs font-mono font-bold">{sIdx+1}</span>
                                                <input placeholder="KG" className="bg-black/40 rounded-xl py-3 text-center text-white font-bold border border-white/5 outline-none focus:border-primary/50 transition-colors" type="number" />
                                                <input placeholder="Reps" className="bg-black/40 rounded-xl py-3 text-center text-white font-bold border border-white/5 outline-none focus:border-primary/50 transition-colors" type="number" />
                                                <input placeholder="RPE" className="bg-black/40 rounded-xl py-3 text-center text-white font-bold border border-white/5 outline-none focus:border-primary/50 transition-colors" type="number" />
                                                <button onClick={()=>{
                                                    const newExs = [...activeWorkoutData.exercises];
                                                    newExs[i].sets[sIdx].completed = !newExs[i].sets[sIdx].completed;
                                                    setActiveWorkoutData(prev=>({...prev, exercises: newExs}));
                                                }} className={`h-12 rounded-xl flex items-center justify-center transition-all ${set.completed ? 'bg-primary text-white shadow-[0_0_15px_rgba(10,132,255,0.4)]' : 'bg-white/5 text-zinc-500 hover:bg-white/10'}`}>
                                                    <Icon name="check" size={20} strokeWidth={3} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                            <button onClick={() => setShowExerciseSelector(true)} className="w-full py-4 rounded-2xl border border-white/10 border-dashed text-zinc-400 flex items-center justify-center gap-2">
                                <Icon name="plus" size={18} /> 添加动作
                            </button>
                        </div>
                        {exerciseDetails && <ExerciseInfoModal />}
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            // 主页 (计划列表)
            if (view === 'templates') {
                return (
                    <div className="min-h-screen bg-transparent pb-24 relative">
                        <BackgroundGlow />
                        
                        {/* 顶部标题栏 - 增加高度避免遮挡 */}
                        <div className="header-spacing px-6 flex justify-between items-center nav-glass sticky top-0 z-20">
                            <div className="flex items-center gap-2">
                                <GeminiStar size={28} className="animate-pulse-slow" />
                                <h1 className="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-white to-white/70">IRON</h1>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="text-white/80 font-medium text-sm bg-white/10 px-3 py-1.5 rounded-full backdrop-blur-md border border-white/5">数据</button>
                        </div>

                        {/* 设置弹窗 */}
                        {isSettingsOpen && (
                            <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-md flex items-end sm:items-center justify-center animate-fade-in" onClick={() => setIsSettingsOpen(false)}>
                                <div className="bg-surface/90 backdrop-blur-xl w-full max-w-md rounded-t-3xl sm:rounded-3xl border-t sm:border border-white/10 p-6 space-y-6 pb-safe relative overflow-hidden" onClick={e=>e.stopPropagation()}>
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary to-accent"></div>
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-white">设置</h2>
                                        <button onClick={() => setIsSettingsOpen(false)} className="text-white bg-white/10 rounded-full p-1"><Icon name="x" size={18}/></button>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={handleExport} className="w-full py-4 bg-white/5 border border-white/5 rounded-2xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform">
                                            <div className="bg-primary/20 p-2 rounded-xl text-primary"><Icon name="download" size={20} /></div>
                                            <span className="flex-1 text-left">备份数据 (导出 JSON)</span>
                                        </button>
                                        <label className="w-full py-4 bg-white/5 border border-white/5 rounded-2xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform cursor-pointer">
                                            <div className="bg-accent/20 p-2 rounded-xl text-accent"><Icon name="upload" size={20} /></div>
                                            <span className="flex-1 text-left">恢复数据 (导入 JSON)</span>
                                            <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                        </label>
                                        <div className="p-4 rounded-2xl bg-black/40 border border-white/5">
                                            <div className="flex justify-between items-center text-sm">
                                                <span className="text-zinc-400">外部动作库</span>
                                                {appData.importedLibrary.length > 0 ?
                                                    <span className="text-accent flex items-center gap-1 font-bold"><Icon name="check-circle" size={14}/> 已连接 ({appData.importedLibrary.length})</span> : 
                                                    <span className="text-zinc-500 flex items-center gap-1"><Icon name="alert-circle" size={14}/> 未检测到</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 计划列表内容 */}
                        <div className="px-4 mt-6 space-y-4">
                            {appData.templates.length === 0 ? (
                                <div className="py-24 text-center relative">
                                    <div className="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-40 h-40 bg-primary/20 rounded-full blur-[60px] pointer-events-none"></div>
                                    <div className="w-20 h-20 bg-gradient-to-br from-surfaceHighlight to-black rounded-3xl border border-white/10 flex items-center justify-center mx-auto mb-6 text-zinc-500 shadow-2xl relative z-10 animate-float">
                                        <GeminiStar size={40} />
                                    </div>
                                    <h3 className="text-white font-bold text-xl relative z-10">开启训练之旅</h3>
                                    <p className="text-zinc-500 text-sm mt-2 mb-10 relative z-10">创建属于你的第一个训练计划</p>
                                    <button onClick={() => setIsCreatingTemplate(true)} className="relative z-10 bg-white text-black px-10 py-4 rounded-full font-bold text-sm shadow-[0_0_20px_rgba(255,255,255,0.3)] active:scale-95 transition-transform">
                                        新建计划
                                    </button>
                                </div>
                            ) : (
                                appData.templates.map(t => (
                                    <div key={t.id} onClick={() => startWorkout(t.exercises)} className="group bg-card-gradient backdrop-blur-sm border border-white/5 rounded-2xl p-5 flex justify-between items-center active:scale-[0.99] transition-all cursor-pointer shadow-lg hover:shadow-[0_0_20px_rgba(255,255,255,0.05)]">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-black flex items-center justify-center border border-white/5 text-primary group-hover:text-white transition-colors">
                                                <span className="font-mono font-bold text-lg">{t.name.charAt(0).toUpperCase()}</span>
                                            </div>
                                            <div>
                                                <h3 className="text-lg font-bold text-white group-hover:text-primary transition-colors">{t.name}</h3>
                                                <p className="text-xs text-zinc-500 mt-1 font-mono">{t.exercises.length} MOVES</p>
                                            </div>
                                        </div>
                                        <div className="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-zinc-500 group-hover:bg-primary group-hover:text-white transition-all">
                                            <Icon name="play" size={14} className="ml-0.5" fill="currentColor" />
                                        </div>
                                    </div>
                                ))
                            )}
                            
                            {appData.templates.length > 0 && (
                                <button onClick={() => setIsCreatingTemplate(true)} className="w-full py-4 bg-white/5 border border-white/5 text-white/70 font-bold rounded-2xl mt-4 active:scale-98 transition-transform hover:bg-white/10 flex items-center justify-center gap-2">
                                    <Icon name="plus" size={18} /> 新建计划
                                </button>
                            )}
                        </div>
                        
                        {/* 底部标签栏 */}
                        <div className="fixed bottom-0 left-0 right-0 nav-glass pb-safe pt-2 px-6 flex justify-around border-t border-white/10 z-20">
                            <button className="flex flex-col items-center p-2 w-16 text-white relative">
                                <div className="absolute -top-2 w-8 h-8 bg-primary/30 blur-lg rounded-full"></div>
                                <Icon name="layout-list" size={24} strokeWidth={2.5} />
                                <span className="text-[10px] font-bold mt-1">计划</span>
                            </button>
                            <button className="flex flex-col items-center p-2 w-16 text-zinc-600 hover:text-zinc-400 transition-colors">
                                <Icon name="bar-chart-2" size={24} strokeWidth={2.5} />
                                <span className="text-[10px] font-bold mt-1">历史</span>
                            </button>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
