<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA æ ¸å¿ƒè®¾ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> 
    <meta name="format-detection" content="telephone=no">
    <title>ç¦…</title>

    <!-- å›¾æ ‡è°ƒç”¨ (è¯·ç¡®ä¿è·¯å¾„æ­£ç¡®) -->
    <link rel="apple-touch-icon" href="./icon.png?v=3.0">
    <link rel="icon" type="image/png" href="./icon.png?v=3.0">
    <link rel="shortcut icon" href="./icon.png?v=3.0">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Zen+Kurenaido&family=Noto+Serif+SC:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        :root {
            /* ğŸ”´ğŸ”´ğŸ”´ ã€æ ¸å¿ƒè°ƒæ•´å‚æ•°ã€‘ ğŸ”´ğŸ”´ğŸ”´
             è¯·ä¿®æ”¹ä¸‹æ–¹çš„æ•°å€¼æ¥æ§åˆ¶åº•éƒ¨æ è·ç¦»å±å¹•åº•éƒ¨çš„è·ç¦»ã€‚
             - æ•°å€¼è¶Šå°ï¼Œåº•éƒ¨æ è¶Šé ä¸‹ï¼Œç©ºç™½è¶Šå°‘ã€‚
             - å»ºè®®å°è¯•ï¼š8px, 12px, 15px, 20px ç›´åˆ°æ»¡æ„ä¸ºæ­¢ã€‚
            */
            --manual-bottom-dist: 6px; 


            --glass-surface: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(255, 255, 255, 0.6);
            --ink-color: #1a1a1a;
            --zen-red: #a73136;
            --zen-bg: #f5f4f0;
            --ios-easing: cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        body {
            font-family: "Noto Serif SC", "Songti SC", serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            background-color: var(--zen-bg);
            color: var(--ink-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* å­—ä½“å·¥å…·ç±» */
        .font-sans-sys { font-family: -apple-system, "PingFang SC", sans-serif; }
        .font-hand { font-family: 'Klee One', cursive; }
        .font-zen { font-family: 'Zen Kurenaido', sans-serif; }
        .font-serif-bold { font-family: 'Noto Serif SC', serif; font-weight: 900; }
        
        /* ç»ç’ƒæ‹Ÿæ€ç»„ä»¶ */
        .glass-panel {
            background: var(--glass-surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.03);
            transform: translateZ(0);
        }

        /* æè‡´ç´§å‡‘çš„åº•éƒ¨å¯¼èˆªæ  - ä½¿ç”¨æ‰‹åŠ¨å‚æ•° */
        .compact-tabbar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 50;
            background: rgba(245, 244, 240, 0.94);
            backdrop-filter: blur(80px);
            -webkit-backdrop-filter: blur(80px);
            border-top: 0.5px solid rgba(0,0,0,0.06); 
            
            /* è¿™é‡Œç›´æ¥ä½¿ç”¨æ‚¨å®šä¹‰çš„å˜é‡ä½œä¸ºåº•éƒ¨å†…è¾¹è· */
            padding-bottom: var(--manual-bottom-dist); 
            padding-top: 6px; 
            
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.02);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* å†…å®¹åŒºåŸŸåº•éƒ¨ç•™ç™½ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡ */
        .safe-pb { padding-bottom: calc(var(--manual-bottom-dist) + 70px); } 
        .safe-pt { padding-top: max(env(safe-area-inset-top), 10px); }

        .bg-noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            position: fixed; inset: 0; pointer-events: none; z-index: -1;
        }
        
        .progress-bar { transition: width 0.6s var(--ios-easing); }
        .animate-page-enter { animation: pageEnter 0.5s var(--ios-easing) forwards; opacity: 0; transform: scale(0.995); }
        @keyframes pageEnter { to { opacity: 1; transform: scale(1); } }
        
        .modal-enter { animation: modalSpring 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.1) forwards; }
        @keyframes modalSpring { from { transform: translateY(100%) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        .active-press { transition: transform 0.1s ease-out; }
        .active-press:active { transform: scale(0.92); }
    </style>
</head>
<body class="overflow-hidden fixed inset-0">
    <div class="bg-noise"></div>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, PenTool, Brain, Volume2, Check, ChevronRight, User,
            RotateCcw, Eraser, Grid, Flame, Settings2, X, Trophy, Sparkles, Filter, Activity, Zap, Download, Upload, Github
        } from 'https://esm.sh/lucide-react@0.292.0';

        // --- å¸¸é‡æ•°æ® ---
        const CONSONANTS = [
            { id: '', label: 'ã‚è¡Œ' }, { id: 'k', label: 'ã‹è¡Œ' }, { id: 's', label: 'ã•è¡Œ' },
            { id: 't', label: 'ãŸè¡Œ' }, { id: 'n', label: 'ãªè¡Œ' }, { id: 'h', label: 'ã¯è¡Œ' },
            { id: 'm', label: 'ã¾è¡Œ' }, { id: 'y', label: 'ã‚„è¡Œ' }, { id: 'r', label: 'ã‚‰è¡Œ' },
            { id: 'w', label: 'ã‚è¡Œ' }, { id: 'n_special', label: 'ã‚“' },
        ];
        const VOWELS = [
            { id: 'a', label: 'ã‚' }, { id: 'i', label: 'ã„' }, { id: 'u', label: 'ã†' },
            { id: 'e', label: 'ãˆ' }, { id: 'o', label: 'ãŠ' },
        ];
        const KANA_MAP = {
            '':  { a: 'ã‚', i: 'ã„', u: 'ã†', e: 'ãˆ', o: 'ãŠ' }, 'k': { a: 'ã‹', i: 'ã', u: 'ã', e: 'ã‘', o: 'ã“' },
            's': { a: 'ã•', i: 'ã—', u: 'ã™', e: 'ã›', o: 'ã' }, 't': { a: 'ãŸ', i: 'ã¡', u: 'ã¤', e: 'ã¦', o: 'ã¨' },
            'n': { a: 'ãª', i: 'ã«', u: 'ã¬', e: 'ã­', o: 'ã®' }, 'h': { a: 'ã¯', i: 'ã²', u: 'ãµ', e: 'ã¸', o: 'ã»' },
            'm': { a: 'ã¾', i: 'ã¿', u: 'ã‚€', e: 'ã‚', o: 'ã‚‚' }, 'y': { a: 'ã‚„', i: null, u: 'ã‚†', e: null, o: 'ã‚ˆ' },
            'r': { a: 'ã‚‰', i: 'ã‚Š', u: 'ã‚‹', e: 'ã‚Œ', o: 'ã‚' }, 'w': { a: 'ã‚', i: null, u: null, e: null, o: 'ã‚’' },
            'n_special': { a: 'ã‚“', i: null, u: null, e: null, o: null }, 
        };
        const KATA_MAP = {
            '':  { a: 'ã‚¢', i: 'ã‚¤', u: 'ã‚¦', e: 'ã‚¨', o: 'ã‚ª' }, 'k': { a: 'ã‚«', i: 'ã‚­', u: 'ã‚¯', e: 'ã‚±', o: 'ã‚³' },
            's': { a: 'ã‚µ', i: 'ã‚·', u: 'ã‚¹', e: 'ã‚»', o: 'ã‚½' }, 't': { a: 'ã‚¿', i: 'ãƒ', u: 'ãƒ„', e: 'ãƒ†', o: 'ãƒˆ' },
            'n': { a: 'ãƒŠ', i: 'ãƒ‹', u: 'ãƒŒ', e: 'ãƒ', o: 'ãƒ' }, 'h': { a: 'ãƒ', i: 'ãƒ’', u: 'ãƒ•', e: 'ãƒ˜', o: 'ãƒ›' },
            'm': { a: 'ãƒ', i: 'ãƒŸ', u: 'ãƒ ', e: 'ãƒ¡', o: 'ãƒ¢' }, 'y': { a: 'ãƒ¤', i: null, u: 'ãƒ¦', e: 'ãƒ¦', o: 'ãƒ¨' },
            'r': { a: 'ãƒ©', i: 'ãƒª', u: 'ãƒ«', e: 'ãƒ¬', o: 'ãƒ­' }, 'w': { a: 'ãƒ¯', i: null, u: null, e: null, o: 'ãƒ²' },
            'n_special': { a: 'ãƒ³', i: null, u: null, e: null, o: null },
        };
        const BACKUP_DB = [
            { w: 'ã‚ã„', m: 'çˆ± (æ„›)', r: 'ai' }, { w: 'ã„ãˆ', m: 'å®¶ (å®¶)', r: 'ie' },
            { w: 'ã†ãˆ', m: 'ä¸Šé¢ (ä¸Š)', r: 'ue' }, { w: 'ã‹ãŠ', m: 'è„¸ (é¡”)', r: 'kao' },
            { w: 'ã‚ã‹', m: 'çº¢è‰² (èµ¤)', r: 'aka' }, { w: 'ãˆã', m: 'è½¦ç«™ (é§…)', r: 'eki' }
        ];
        
        // --- é€»è¾‘å±‚ ---
        const Storage = {
            get: (key, def) => { try { return JSON.parse(localStorage.getItem(key)) || def; } catch { return def; } },
            set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
            export: () => {
                const data = { srs: JSON.parse(localStorage.getItem('zen_srs_data') || '{}'), heatmap: JSON.parse(localStorage.getItem('zen_heatmap') || '{}'), ver: 1 };
                return btoa(JSON.stringify(data));
            },
            import: (str) => {
                try {
                    const data = JSON.parse(atob(str));
                    localStorage.setItem('zen_srs_data', JSON.stringify(data.srs));
                    localStorage.setItem('zen_heatmap', JSON.stringify(data.heatmap));
                    return true;
                } catch (e) { return false; }
            }
        };
        const SRS = {
            updateItem: (itemId, quality) => { 
                const data = Storage.get('zen_srs_data', {});
                const item = data[itemId] || { interval: 0, repetitions: 0, ef: 2.5, nextReview: 0 };
                if (quality >= 3) {
                    if (item.repetitions === 0) item.interval = 1;
                    else if (item.repetitions === 1) item.interval = 6;
                    else item.interval = Math.round(item.interval * item.ef);
                    item.repetitions += 1;
                    item.ef = item.ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
                    if (item.ef < 1.3) item.ef = 1.3;
                } else {
                    item.repetitions = 0;
                    item.interval = 1;
                }
                item.nextReview = Date.now() + (item.interval * 24 * 60 * 60 * 1000);
                data[itemId] = item;
                Storage.set('zen_srs_data', data);
                ZenStreak.addActivity();
                return item;
            },
            getDueItems: () => {
                const data = Storage.get('zen_srs_data', {});
                const now = Date.now();
                return Object.keys(data).filter(id => data[id].nextReview <= now);
            },
            getAll: () => Storage.get('zen_srs_data', {})
        };
        const ZenStreak = {
            addActivity: () => {
                const today = new Date().toISOString().split('T')[0];
                const heatmap = Storage.get('zen_heatmap', {});
                heatmap[today] = (heatmap[today] || 0) + 1;
                Storage.set('zen_heatmap', heatmap);
            },
            getData: () => Storage.get('zen_heatmap', {}),
            getTotalDays: () => Object.keys(Storage.get('zen_heatmap', {})).length
        };
        const speak = (text) => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP'; u.rate = 0.85;
            window.speechSynthesis.speak(u);
        };

        // --- ç»„ä»¶ ---
        function SettingsModal({ onClose }) {
            const handleClear = () => {
                if(confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­¦ä¹ è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                    localStorage.clear();
                    location.reload();
                }
            };
            return (
                <div className="fixed inset-0 z-[100] bg-stone-900/10 backdrop-blur-[4px] flex items-end sm:items-center justify-center" onClick={onClose}>
                    <div className="w-full max-w-sm bg-[#f5f4f0] sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl modal-enter border border-white/60 ring-1 ring-black/5" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-serif-bold text-stone-800 tracking-tight">è®¾ç½®ä¸å…³äº</h3>
                            <button onClick={onClose} className="p-2 bg-stone-200/50 rounded-full text-stone-600 active-press"><X size={18}/></button>
                        </div>
                        <div className="space-y-4">
                            <div className="glass-panel p-4 rounded-2xl flex items-center gap-4">
                                <div className="w-12 h-12 bg-[#a73136] rounded-xl flex items-center justify-center text-white font-serif-bold text-2xl shadow-lg ring-1 ring-white/30">ç¦…</div>
                                <div>
                                    <div className="font-bold text-stone-800 text-lg">Zen Gojuon</div>
                                    <div className="text-xs text-stone-500 font-sans-sys tracking-wide">v6.2.0 Manual Fit</div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <button onClick={() => window.open('https://github.com/your-username/your-repo', '_blank')} className="w-full p-4 rounded-2xl bg-white flex items-center justify-between text-stone-700 active-press shadow-sm border border-stone-100">
                                    <span className="flex items-center gap-3 font-medium"><Github size={18}/> GitHub ä»“åº“</span>
                                    <ChevronRight size={16} className="text-stone-300"/>
                                </button>
                                <button onClick={handleClear} className="w-full p-4 rounded-2xl bg-white flex items-center justify-between text-red-600 active-press shadow-sm border border-stone-100">
                                    <span className="flex items-center gap-3 font-medium"><Eraser size={18}/> é‡ç½®æ•°æ®</span>
                                    <ChevronRight size={16} className="text-red-200"/>
                                </button>
                            </div>
                            <div className="text-center text-[10px] text-stone-400 font-sans-sys pt-4 tracking-widest uppercase">
                                Designed for iOS Â· Wabi-sabi Style
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        function HeatmapWidget({ className }) {
            const [data, setData] = useState({});
            useEffect(() => { setData(ZenStreak.getData()); }, []);
            const days = Array.from({length: 7}, (_, i) => {
                const d = new Date(); d.setDate(d.getDate() - (6 - i));
                return d.toISOString().split('T')[0];
            });
            return (
                <div className={`glass-panel p-5 rounded-[28px] relative overflow-hidden ${className}`}>
                    <div className="flex justify-between items-center mb-3 relative z-10">
                        <div className="flex items-center gap-2">
                            <Flame size={18} className="text-[#a73136]" fill="#a73136" />
                            <span className="text-xs font-bold font-sans-sys text-stone-500 tracking-wider">ä¿®è¡Œè¶³è¿¹</span>
                        </div>
                        <span className="text-[10px] font-bold text-[#a73136] bg-red-50/80 px-2 py-1 rounded-md font-sans-sys">è¿‘ä¸ƒæ—¥</span>
                    </div>
                    <div className="flex justify-between gap-2 relative z-10">
                        {days.map(day => {
                            const count = data[day] || 0;
                            const opacity = count === 0 ? 0.08 : Math.min(count * 0.2 + 0.2, 1);
                            return (
                                <div key={day} className="flex-1 aspect-[3/4] rounded-lg transition-colors duration-500" style={{ backgroundColor: `rgba(167, 49, 54, ${opacity})` }}></div>
                            )
                        })}
                    </div>
                </div>
            );
        }

        function ChartMode() {
            const [type, setType] = useState('h');
            return (
                <div className="safe-pb animate-page-enter">
                    <div className="sticky top-0 safe-pt z-20 pb-4 flex justify-center border-b border-stone-200/50 shadow-sm" style={{background: 'rgba(245, 244, 240, 0.96)', backdropFilter: 'blur(40px)'}}>
                         <div className="glass-panel rounded-full p-1 inline-flex scale-95">
                            <button onClick={() => setType('h')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 ${type === 'h' ? 'bg-white shadow-md text-[#a73136]' : 'text-stone-400 hover:text-stone-600'}`}>å¹³ä»®å</button>
                            <button onClick={() => setType('k')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 ${type === 'k' ? 'bg-white shadow-md text-[#a73136]' : 'text-stone-400 hover:text-stone-600'}`}>ç‰‡ä»®å</button>
                        </div>
                    </div>
                    <div className="grid gap-4 px-5 mt-6">
                        {CONSONANTS.map(row => (
                            <div key={row.id} className="flex gap-3 items-center">
                                <div className="w-6 flex flex-col items-center justify-center text-xs font-bold text-stone-300 gap-1 font-serif-bold opacity-60">
                                    {row.label.split('').map((c,i) => <span key={i}>{c}</span>)}
                                </div>
                                <div className="grid grid-cols-5 gap-2 flex-1">
                                    {VOWELS.map(col => {
                                        const map = type === 'h' ? KANA_MAP : KATA_MAP;
                                        const char = map[row.id]?.[col.id];
                                        if (!char && row.id !== 'n_special') return <div key={col.id} />;
                                        if (row.id === 'n_special' && col.id !== 'a') return <div key={col.id} />;
                                        const displayChar = row.id === 'n_special' ? map['n_special'].a : char;
                                        return (
                                            <button key={col.id} onClick={() => speak(displayChar)} className="glass-panel aspect-square rounded-2xl flex flex-col items-center justify-center active-press active:bg-white/80 transition-colors">
                                                <span className="text-2xl font-hand text-stone-700">{displayChar}</span>
                                                <span className="text-[9px] text-stone-300 font-sans-sys font-bold mt-0.5 uppercase opacity-60">{row.id === 'n_special' ? 'n' : (row.id + col.id)}</span>
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function WritingCard({ char, label }) {
            const canvasRef = useRef(null);
            const clear = () => {
                const canvas = canvasRef.current;
                if(!canvas) return; const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.save(); ctx.strokeStyle = 'rgba(167, 49, 54, 0.08)'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(canvas.width/2, 0); ctx.lineTo(canvas.width/2, canvas.height); ctx.stroke();
                ctx.restore();
            };
            const draw = (e) => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const x = e.touches[0].clientX - rect.left; const y = e.touches[0].clientY - rect.top;
                if (e.type === 'touchstart') {
                    ctx.beginPath();
                    ctx.moveTo(x, y); ctx.lineWidth = 8; canvas.lastX = x; canvas.lastY = y; canvas.isDrawing = true;
                } else if (e.type === 'touchend') { canvas.isDrawing = false;
                } else if (canvas.isDrawing) {
                    const dist = Math.hypot(x - canvas.lastX, y - canvas.lastY);
                    const newWidth = Math.max(4, 12 - dist * 0.5);
                    ctx.beginPath(); ctx.moveTo(canvas.lastX, canvas.lastY); ctx.lineTo(x, y); ctx.lineWidth = newWidth; ctx.stroke();
                    canvas.lastX = x; canvas.lastY = y;
                }
            };
            useEffect(() => {
                const canvas = canvasRef.current;
                if(canvas) {
                    canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
                    const ctx = canvas.getContext('2d'); ctx.strokeStyle = '#2c2c2c'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    ctx.shadowBlur = 2; ctx.shadowColor = 'rgba(0,0,0,0.2)'; clear();
                }
            }, [char]);
            return (
                <div className="glass-panel rounded-[32px] relative overflow-hidden transition-all duration-300">
                    <div className="absolute top-4 left-5 right-5 flex justify-between items-center z-20 pointer-events-none">
                        <span className="text-[10px] font-bold font-sans-sys text-stone-400 tracking-widest uppercase">{label}</span>
                        <div className="flex gap-2 pointer-events-auto">
                            <button onClick={() => speak(char)} className="p-2 rounded-full bg-white/40 backdrop-blur active-press text-stone-600"><Volume2 size={18}/></button>
                            <button onClick={clear} className="p-2 rounded-full bg-white/40 backdrop-blur active-press text-stone-600"><Eraser size={18}/></button>
                        </div>
                    </div>
                    <div className="relative aspect-square">
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none select-none">
                            <span className="text-[13rem] font-hand leading-none text-[#a73136]/10">{char}</span>
                        </div>
                        <canvas ref={canvasRef} className="w-full h-full relative z-10 touch-none" onTouchStart={draw} onTouchMove={draw} onTouchEnd={draw} />
                    </div>
                </div>
            );
        }

        function PracticeMode() {
            const [char, setChar] = useState({ h: 'ã‚', k: 'ã‚¢', r: 'a' });
            const [practiceType, setPracticeType] = useState('h'); 
            const [isOpen, setIsOpen] = useState(false);
            const allChars = useMemo(() => {
                const list = [];
                CONSONANTS.forEach(row => {
                    VOWELS.forEach(col => {
                        const h = KANA_MAP[row.id]?.[col.id]; const k = KATA_MAP[row.id]?.[col.id];
                        if (h) list.push({ h, k, r: row.id + col.id });
                    });
                    if(row.id === 'n_special') list.push({ h: 'ã‚“', k: 'ãƒ³', r: 'n' });
                });
                return list;
            }, []);
            return (
                <div className="safe-pb animate-page-enter">
                    <div className="sticky top-0 safe-pt z-20 pb-4 flex justify-center border-b border-stone-200/50 shadow-sm" style={{background: 'rgba(245, 244, 240, 0.96)', backdropFilter: 'blur(40px)'}}>
                         <div className="glass-panel rounded-full p-1 inline-flex scale-95">
                            <button onClick={() => setPracticeType('h')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 ${practiceType === 'h' ? 'bg-white shadow-md text-[#a73136]' : 'text-stone-400 hover:text-stone-600'}`}>å¹³ä»®å</button>
                            <button onClick={() => setPracticeType('k')} className={`px-6 py-2 rounded-full text-sm font-bold transition-all duration-300 ${practiceType === 'k' ? 'bg-white shadow-md text-[#a73136]' : 'text-stone-400 hover:text-stone-600'}`}>ç‰‡ä»®å</button>
                        </div>
                    </div>

                    <div className="px-5 space-y-6 mt-6">
                        <button onClick={() => setIsOpen(!isOpen)} className="w-full glass-panel p-5 rounded-[28px] flex items-center justify-between active-press relative z-20">
                            <div className="flex items-center gap-4">
                                <div className="bg-[#a73136] text-white p-2.5 rounded-xl shadow-lg shadow-red-900/10"><Grid size={20} /></div>
                                <div className="text-left">
                                    <div className="font-bold text-stone-700 text-base">é€‰æ‹©å‡å</div>
                                    <div className="text-[10px] text-stone-400 font-sans-sys font-bold tracking-wider mt-0.5">CURRENT: {char.r.toUpperCase()}</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 pr-2">
                                <span className="text-3xl font-hand text-stone-700">{practiceType === 'h' ? char.h : char.k}</span>
                                <ChevronRight className={`ml-2 transition-transform duration-300 text-stone-300 ${isOpen ? 'rotate-90' : ''}`} size={20} />
                            </div>
                        </button>
                        
                        {isOpen && (
                            <div className="fixed inset-0 z-50 bg-stone-900/10 backdrop-blur-[2px]" onClick={() => setIsOpen(false)}>
                                <div className="absolute bottom-0 left-0 right-0 glass-panel rounded-t-[32px] p-6 safe-pb modal-enter border-t border-white/50" onClick={e => e.stopPropagation()}>
                                    <div className="grid grid-cols-6 gap-3 max-h-[50vh] overflow-y-auto no-scrollbar">
                                        {allChars.map((c, i) => (
                                            <button key={i} onClick={() => { setChar(c); setIsOpen(false); }} className={`aspect-square rounded-2xl flex flex-col items-center justify-center transition-all ${c.h === char.h ? 'bg-[#a73136] text-white shadow-lg scale-105' : 'bg-white/50 text-stone-600'}`}>
                                                <div className="font-hand text-xl">{practiceType === 'h' ? c.h : c.k}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="grid grid-cols-1 gap-6">
                            <WritingCard char={practiceType === 'h' ? char.h : char.k} label={practiceType === 'h' ? 'Hiragana' : 'Katakana'} />
                        </div>
                    </div>
                </div>
            );
        }

        function ProfileMode({ onStartWeakMode }) {
            const [stats, setStats] = useState({ days: 0, srsCount: 0 });
            const [matrix, setMatrix] = useState({});

            useEffect(() => {
                setStats({ days: ZenStreak.getTotalDays(), srsCount: Object.keys(SRS.getAll()).length });
                setMatrix(SRS.getAll());
            }, []);
            const handleExport = () => {
                const str = Storage.export();
                navigator.clipboard.writeText(str).then(() => {
                    Toastify({ text: "å¤‡ä»½ç å·²å¤åˆ¶", duration: 2000, style: { background: "#a73136", borderRadius: "10px" } }).showToast();
                });
            };
            const handleImport = () => {
                const str = prompt("ç²˜è´´å¤‡ä»½ç ï¼š");
                if (str && Storage.import(str)) {
                    Toastify({ text: "æ•°æ®æ¢å¤æˆåŠŸ", duration: 2000, style: { background: "#2ecc71", borderRadius: "10px" } }).showToast();
                    setTimeout(() => location.reload(), 1500);
                }
            };
            return (
                <div className="safe-pb animate-page-enter px-5 space-y-6 pt-6">
                    <HeatmapWidget />
                    <div className="grid grid-cols-2 gap-4">
                        <div className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                            <span className="text-3xl font-serif-bold text-stone-700">{stats.days}</span>
                            <span className="text-[10px] text-stone-400 font-bold uppercase tracking-wider">æ‰“å¡å¤©æ•°</span>
                        </div>
                        <div className="glass-panel p-4 rounded-2xl flex flex-col items-center justify-center gap-1">
                            <span className="text-3xl font-serif-bold text-stone-700">{stats.srsCount}</span>
                            <span className="text-[10px] text-stone-400 font-bold uppercase tracking-wider">æŒæ¡è¯æ±‡</span>
                        </div>
                    </div>

                    <div className="glass-panel p-5 rounded-[28px]">
                        <div className="flex justify-between items-center mb-4">
                            <div className="flex items-center gap-2">
                                <Activity size={18} className="text-[#a73136]" />
                                <span className="font-bold text-stone-700 text-sm">è®°å¿†çŸ©é˜µ</span>
                            </div>
                            <button onClick={onStartWeakMode} className="text-xs bg-[#a73136] text-white px-3 py-1.5 rounded-lg shadow-lg shadow-red-900/20 active-press flex items-center gap-1">
                                <Zap size={12} fill="white"/> å¼±é¡¹çªå‡»
                            </button>
                        </div>
                        
                        <div className="grid grid-cols-5 gap-1.5">
                             {['a','i','u','e','o'].map(col => (
                                CONSONANTS.map(row => {
                                    const char = KANA_MAP[row.id]?.[col] || (row.id==='n_special'&&col==='a'?'ã‚“':null);
                                    if(!char) return null;
                                    const item = Object.values(matrix).find(v => v && v.key === char) || matrix[char];
                                    let colorClass = 'bg-stone-100/50 text-stone-300';
                                    if (item) {
                                        const now = Date.now();
                                        if (item.nextReview < now) colorClass = 'bg-red-100 text-red-600 border border-red-200';
                                        else if (item.interval > 30) colorClass = 'bg-emerald-100 text-emerald-700 border border-emerald-200';
                                        else if (item.interval > 7) colorClass = 'bg-green-50 text-green-600 border border-green-100';
                                        else colorClass = 'bg-yellow-50 text-yellow-600 border border-yellow-100';
                                    }
                                    return (
                                        <div key={row.id+col} className={`aspect-square rounded-lg flex items-center justify-center text-lg font-hand transition-colors ${colorClass}`}>
                                            {char}
                                        </div>
                                    )
                                })
                            ))}
                        </div>
                    </div>

                    <div className="glass-panel p-4 rounded-2xl flex gap-2">
                        <button onClick={handleExport} className="flex-1 py-3 rounded-xl bg-stone-50 text-stone-600 text-xs font-bold flex flex-col items-center gap-1 active-press">
                            <Download size={16} /> å¤‡ä»½æ•°æ®
                        </button>
                        <button onClick={handleImport} className="flex-1 py-3 rounded-xl bg-stone-50 text-stone-600 text-xs font-bold flex flex-col items-center gap-1 active-press">
                            <Upload size={16} /> æ¢å¤æ•°æ®
                        </button>
                    </div>
                </div>
            );
        }

        function QuizMode({ vocabList, startMode, onExit }) { 
            const [step, setStep] = useState(startMode ? 'quiz' : 'lobby');
            const [mode, setMode] = useState(startMode || 'srs');
            const [selRows, setSelRows] = useState([]);
            const [currentQ, setCurrentQ] = useState(null);
            const [progress, setProgress] = useState(0);
            const [isCorrect, setIsCorrect] = useState(null);
            const [dueCount, setDueCount] = useState(0);
            const [weakQueue, setWeakQueue] = useState([]);
            useEffect(() => {
                const due = SRS.getDueItems();
                setDueCount(due.length);
                if (startMode === 'weak') initWeakMode();
            }, [startMode]);
            const initWeakMode = () => {
                const allData = SRS.getAll();
                const now = Date.now();
                const weakKeys = Object.keys(allData).filter(key => {
                    const item = allData[key];
                    return item.nextReview <= now || item.ef < 2.0;
                });
                const weakItems = vocabList.filter(v => weakKeys.includes(v.w));
                if (weakItems.length === 0) {
                    alert("æš‚æ— éœ€è¦çªå‡»çš„å¼±é¡¹ï¼");
                    if(onExit) onExit(); else setStep('lobby');
                    return;
                }
                setWeakQueue(weakItems);
                setMode('weak');
                setTimeout(() => nextQuestion(weakItems), 100);
            };

            const toggleRow = (id) => setSelRows(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            const getQuestionPool = () => {
                if (mode === 'srs') return vocabList;
                if (mode === 'custom') {
                    const allowedChars = new Set();
                    CONSONANTS.forEach(row => {
                        if (selRows.includes(row.id)) {
                            VOWELS.forEach(col => {
                                const char = KANA_MAP[row.id]?.[col.id];
                                if (char) allowedChars.add(char);
                            });
                            if(row.id === 'n_special') allowedChars.add('ã‚“');
                        }
                    });
                    return vocabList.filter(word => word.w.split('').some(c => allowedChars.has(c)));
                }
                return vocabList;
            };

            const nextQuestion = (overrideQueue = null) => {
                if (mode === 'weak') {
                    const queue = overrideQueue || weakQueue;
                    if (queue.length === 0) { setStep('result'); return; }
                    const target = queue[0];
                    generateOptions(target);
                    return;
                }
                if (progress >= 10) { setStep('result'); return; }
                const pool = getQuestionPool();
                if (pool.length === 0) { alert("èŒƒå›´å¤ªå°æˆ–æ— è¯æ±‡"); setStep('config'); return; }
                const target = pool[Math.floor(Math.random() * pool.length)];
                generateOptions(target);
            };

            const generateOptions = (target) => {
                const distractors = [];
                while (distractors.length < 3) {
                    const d = vocabList[Math.floor(Math.random() * vocabList.length)];
                    if (d.w !== target.w && !distractors.includes(d.w)) distractors.push(d.w);
                }
                const options = [...distractors, target.w].sort(() => 0.5 - Math.random());
                setCurrentQ({ word: target.r, mean: target.m, answer: target.w, options: options, raw: target });
                setIsCorrect(null);
            };
            const handleAnswer = (selected) => {
                if (isCorrect !== null) return;
                const correct = selected === currentQ.answer;
                setIsCorrect(correct);
                speak(currentQ.answer);
                SRS.updateItem(currentQ.answer, correct ? 5 : 0);
                if (mode === 'weak') {
                    const newQueue = [...weakQueue];
                    if (correct) newQueue.shift();
                    else { const item = newQueue.shift(); newQueue.push(item); }
                    setWeakQueue(newQueue);
                    setTimeout(() => nextQuestion(newQueue), 1200);
                } else {
                    setTimeout(() => { setProgress(p => p + 1); nextQuestion(); }, 1200);
                }
            };
            if (step === 'lobby') {
                return (
                    <div className="safe-pb animate-page-enter px-6 flex flex-col items-center justify-center h-[80vh]">
                        <div className="w-24 h-24 bg-[#a73136] rounded-[32px] flex items-center justify-center text-white mb-6 shadow-2xl shadow-red-900/20 rotate-6 ring-4 ring-white/50">
                            <Brain size={48} />
                        </div>
                        <h2 className="text-3xl font-bold text-stone-800 mb-2 font-serif-bold">è¯•ç‚¼ä¹‹é—´</h2>
                        <p className="text-stone-400 mb-8 text-center text-sm px-4 leading-relaxed">
                            æ€»è¯æ±‡é‡: {vocabList.length} è¯<br/>
                            {dueCount > 0 ? `ä»Šæ—¥å¾…å¤ä¹ : ${dueCount} ä¸ª` : "ä»Šæ—¥è®°å¿†ä»»åŠ¡å·²å®Œæˆ"}
                        </p>
                        <div className="w-full space-y-4">
                            <button onClick={() => { setMode('srs'); setProgress(0); setStep('quiz'); setTimeout(nextQuestion, 0); }} className="w-full h-20 bg-[#a73136] text-white rounded-[24px] font-bold shadow-xl shadow-red-900/20 flex items-center px-6 gap-4 active-press relative overflow-hidden group">
                                <div className="p-3 bg-white/20 rounded-full"><Sparkles size={24} /></div>
                                <div className="text-left flex-1">
                                    <div className="text-lg">æ™ºèƒ½å¤ä¹ </div>
                                    <div className="text-[10px] opacity-80 font-sans-sys font-normal">åŸºäºé—å¿˜æ›²çº¿ Â· å…¨åº“éšæœº</div>
                                </div>
                            </button>
                            <button onClick={() => setStep('config')} className="w-full h-20 glass-panel text-stone-700 rounded-[24px] font-bold shadow-sm flex items-center px-6 gap-4 active-press">
                                <div className="p-3 bg-stone-100 rounded-full text-stone-500"><Filter size={24} /></div>
                                <div className="text-left">
                                    <div className="text-lg">ä¸“é¡¹ç‰¹è®­</div>
                                    <div className="text-[10px] text-stone-400 font-sans-sys font-normal">æ‰‹åŠ¨é€‰æ‹©å‡åè¡Œ Â· é’ˆå¯¹å¼±é¡¹</div>
                                </div>
                            </button>
                        </div>
                    </div>
                );
            }

            if (step === 'config') {
                return (
                    <div className="safe-pb animate-page-enter px-5 pt-6">
                        <div className="glass-panel p-6 rounded-[32px] mb-6">
                            <div className="flex justify-between items-center mb-6">
                                <h3 className="font-bold text-lg text-stone-800">é€‰æ‹©èŒƒå›´</h3>
                                <button onClick={() => setStep('lobby')} className="p-2 bg-stone-100 rounded-full active-press"><X size={18} className="text-stone-500"/></button>
                            </div>
                            <div className="grid grid-cols-4 gap-2 mb-6">
                                {CONSONANTS.map(row => (
                                    <button key={row.id} onClick={() => toggleRow(row.id)} className={`h-12 rounded-xl text-sm font-bold transition-all duration-200 border ${selRows.includes(row.id) ? 'bg-[#a73136] border-[#a73136] text-white shadow-md' : 'bg-white/50 border-stone-200 text-stone-400'}`}>
                                        {row.label.split(' ')[0]}
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => { if(selRows.length===0) return; setProgress(0); nextQuestion(); setStep('quiz'); }} disabled={selRows.length === 0} className="w-full h-14 bg-[#2c2c2c] text-white rounded-xl font-bold flex items-center justify-center gap-2 active-press">
                                å¼€å§‹ <ChevronRight size={18} />
                            </button>
                        </div>
                    </div>
                )
            }

            if (step === 'result') {
                return (
                    <div className="safe-pb animate-page-enter px-6 flex flex-col items-center justify-center h-[80vh]">
                        <div className="w-24 h-24 bg-white border border-stone-200 rounded-[32px] flex items-center justify-center text-[#a73136] mb-8 shadow-xl">
                            <Trophy size={48} />
                        </div>
                        <h2 className="text-2xl font-serif-bold text-stone-800 mb-2">ä¿®è¡Œç»“æŸ</h2>
                        <button onClick={() => { if(onExit) onExit(); else setStep('lobby'); }} className="w-full h-14 glass-panel text-stone-600 rounded-2xl font-bold mt-8 flex items-center justify-center gap-2 active-press">
                            <RotateCcw size={20} /> è¿”å›
                        </button>
                    </div>
                )
            }

            if (!currentQ) return <div className="text-center pt-20">Loading...</div>;
            return (
                <div className="safe-pb animate-page-enter px-5 pt-4 h-full flex flex-col relative pb-[calc(env(safe-area-inset-bottom)+90px)]">
                    <div className="w-full h-1.5 bg-stone-200 rounded-full mb-6 overflow-hidden">
                        <div className={`h-full progress-bar ${mode === 'weak' ? 'bg-red-500' : 'bg-[#a73136]'}`} style={{width: mode==='weak' ? '100%' : `${(progress / 10) * 100}%`}}></div>
                    </div>
                    
                    <div className="glass-panel rounded-[32px] p-8 text-center mb-6 flex-1 flex flex-col justify-center items-center relative overflow-hidden">
                        <div className="text-xs font-bold text-[#a73136] tracking-[0.3em] uppercase opacity-60 mb-4 font-sans-sys">Translate</div>
                        <h2 className="text-5xl font-serif-bold text-stone-800 mb-3 tracking-wide">{currentQ.word}</h2>
                        <div className="text-lg text-stone-500 font-medium">{currentQ.mean}</div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mb-4">
                        {currentQ.options.map((opt, i) => {
                            let stateClass = 'bg-white/60 text-stone-600 hover:bg-white';
                            if (isCorrect !== null) {
                                if (opt === currentQ.answer) stateClass = 'bg-[#a73136] text-white border-[#a73136]';
                                else if (opt !== currentQ.answer && isCorrect === false) stateClass = 'opacity-40';
                            }
                            return <button key={i} onClick={() => handleAnswer(opt)} disabled={isCorrect !== null} className={`h-16 rounded-2xl font-bold text-xl font-hand transition-all duration-300 border border-transparent shadow-sm active-press ${stateClass}`}>{opt}</button>
                        })}
                    </div>
                </div>
            );
        }

        function JapaneseZenApp() {
            const [activeTab, setActiveTab] = useState('quiz');
            const [fadeIn, setFadeIn] = useState(false);
            const [vocabList, setVocabList] = useState(BACKUP_DB);
            const [startWeakMode, setStartWeakMode] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            useEffect(() => {
                setFadeIn(true);
                fetch('./vocab.json')
                    .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                    .catch(() => {});
            }, []);
            return (
                <div className={`h-full flex flex-col transition-opacity duration-1000 ease-in ${fadeIn ? 'opacity-100' : 'opacity-0'}`}>
                    <header className="safe-pt px-6 pb-2 sticky top-0 z-40 flex justify-between items-center h-[54px]" style={{background: 'rgba(245, 244, 240, 0.96)', backdropFilter: 'blur(40px)', borderBottom: '1px solid rgba(0,0,0,0.05)'}}>
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 bg-[#a73136] rounded-xl text-white flex items-center justify-center font-serif-bold text-lg shadow-lg shadow-red-900/20 ring-1 ring-white/50">ç¦…</div>
                            <div className="flex flex-col justify-center h-9">
                                <span className="font-serif-bold text-stone-800 text-base leading-none tracking-widest">GOJUON</span>
                            </div>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="w-8 h-8 rounded-full bg-stone-200/50 flex items-center justify-center active-press transition-colors">
                            <Settings2 size={16} className="text-stone-600" />
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto no-scrollbar relative w-full mx-auto max-w-xl">
                        <div key={activeTab}>
                            {activeTab === 'chart' && <ChartMode />}
                            {activeTab === 'practice' && <PracticeMode />}
                            {activeTab === 'quiz' && <QuizMode vocabList={vocabList} startMode={startWeakMode} onExit={() => setStartWeakMode(false)} />}
                            {activeTab === 'profile' && <ProfileMode onStartWeakMode={() => { setActiveTab('quiz'); setStartWeakMode('weak'); }} />}
                        </div>
                    </main>

                    {/* V6.2 æ‰‹åŠ¨æ§åˆ¶è·ç¦» TabBar */}
                    <div className="compact-tabbar">
                        {[
                            { id: 'chart', icon: BookOpen, label: 'é˜…è§ˆ' },
                            { id: 'practice', icon: PenTool, label: 'ä¸´æ‘¹' },
                            { id: 'quiz', icon: Brain, label: 'è¯•ç‚¼' },
                            { id: 'profile', icon: User, label: 'æˆ‘çš„' },
                        ].map(tab => {
                            const Icon = tab.icon; const isActive = activeTab === tab.id;
                            return (
                                <button 
                                    key={tab.id} 
                                    onClick={() => { setActiveTab(tab.id); setStartWeakMode(false); }} 
                                    className={`flex flex-col items-center justify-end w-full relative group active:scale-95 transition-transform duration-200 ease-out`}
                                    style={{ WebkitTapHighlightColor: 'transparent', height: '48px', paddingBottom: '4px' }}
                                >
                                    <Icon 
                                        size={26} 
                                        strokeWidth={isActive ? 2.5 : 1.5} 
                                        className={`transition-all duration-300 ${isActive ? 'text-[#a73136] -translate-y-0.5' : 'text-stone-400'}`} 
                                    />
                                    <span className={`text-[9px] font-bold font-sans-sys mt-0.5 transition-colors duration-300 ${isActive ? 'text-[#a73136]' : 'text-stone-300'}`}>
                                        {tab.label}
                                    </span>
                                </button>
                            )
                        })}
                    </div>

                    {showSettings && <SettingsModal onClose={() => setShowSettings(false)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<JapaneseZenApp />);
    </script>
</body>
</html>
