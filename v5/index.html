<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IRON</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#000000', 
                        surface: '#1c1c1e', // iOS System Gray 6 Dark
                        surfaceHighlight: '#2c2c2e', // iOS System Gray 5 Dark
                        primary: '#0a84ff', // iOS Blue
                        accent: '#30d158', // iOS Green 
                        danger: '#ff453a', // iOS Red
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #000000; 
            color: #f2f2f7; 
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "ss01", "ss02"; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Clean iOS style glass */
        .glass {
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 0.5px solid rgba(255, 255, 255, 0.15);
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="h-full selection:bg-primary selection:text-white">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 1. Data Models & Storage ---
        const STORAGE_KEY = 'iron_app_data_v6_clean';

        const initialData = {
            templates: [], 
            customExercises: [], 
            history: {},
            importedLibrary: [] 
        };

        const useStorage = () => {
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : initialData;
                } catch (e) { return initialData; }
            });

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);

            return [data, setData];
        };

        // --- 2. Advanced Recursive Parser ---
        // This parser can handle Arrays, Objects, Nested Objects (Arms -> Biceps), basically anything.
        const useExternalLibrary = (setAppData) => {
            useEffect(() => {
                const fetchLibrary = async () => {
                    try {
                        const response = await fetch('./exercise_library.json');
                        if (!response.ok) throw new Error('Network response was not ok');
                        
                        // NOTE: If JSON is still malformed (multiple roots), this line will fail.
                        // User MUST fix the JSON file first.
                        const json = await response.json();
                        
                        const parseRecursive = (obj, contextKey = '') => {
                            let extracted = [];
                            
                            // Case A: It's an Array -> These are exercises
                            if (Array.isArray(obj)) {
                                return obj.map(ex => {
                                    // Combine all possible muscle fields
                                    const combinedMuscles = [
                                        ...(ex.muscle_group || []),
                                        ...(ex.primary_muscle || []),
                                        ...(ex.secondary_muscle || [])
                                    ];
                                    // Try to determine category from muscles, or fallback to parent key (e.g. "Back")
                                    const catSource = combinedMuscles.length > 0 ? combinedMuscles : [contextKey];
                                    
                                    return {
                                        id: `ext_${(ex.id || ex.name).replace(/\s+/g, '')}_${Math.random().toString(36).substr(2,5)}`,
                                        name: ex.name,
                                        category: normalizeCategory(catSource),
                                        muscles: normalizeMuscles(combinedMuscles),
                                        rawMuscles: ex.primary_muscle || ex.muscle_group,
                                        instructions: ex.instructions || ex.cues,
                                        mistakes: ex.common_mistakes || ex.common_mistakes
                                    };
                                });
                            }
                            
                            // Case B: It's an Object -> Dig deeper
                            if (typeof obj === 'object' && obj !== null) {
                                Object.keys(obj).forEach(key => {
                                    if (key === 'version') return; // Skip metadata
                                    // Recurse down, passing the current key (e.g., "Arms") as context
                                    extracted = [...extracted, ...parseRecursive(obj[key], key)];
                                });
                            }
                            
                            return extracted;
                        };

                        const exercises = parseRecursive(json);

                        if (exercises.length > 0) {
                            console.log(`Loaded ${exercises.length} external exercises.`);
                            setAppData(prev => ({ ...prev, importedLibrary: exercises }));
                        }
                    } catch (error) {
                        console.log("Library load error (File missing or JSON syntax error):", error);
                    }
                };
                fetchLibrary();
            }, []);
        };

        // Helper: Convert various strings to internal IDs
        const normalizeCategory = (input) => {
            const str = JSON.stringify(input).toLowerCase();
            if (str.includes('chest') || str.includes('胸')) return 'CHEST';
            if (str.includes('back') || str.includes('背') || str.includes('lats')) return 'BACK';
            if (str.includes('leg') || str.includes('腿') || str.includes('squat') || str.includes('quad')) return 'LEGS';
            if (str.includes('glute') || str.includes('臀')) return 'GLUTES';
            if (str.includes('shoulder') || str.includes('delt') || str.includes('肩')) return 'SHOULDERS';
            if (str.includes('arm') || str.includes('biceps') || str.includes('triceps') || str.includes('臂') || str.includes('二头') || str.includes('三头')) return 'ARMS';
            return 'CORE';
        };

        const normalizeMuscles = (input) => {
            const muscleMap = {
                '胸': 'chest_major', 'chest': 'chest_major', 'pec': 'chest_major',
                '背': 'lats', 'lat': 'lats', 'traps': 'traps_upper',
                '腿': 'quads', 'quad': 'quads', 'hamstring': 'hamstrings', 'calf': 'calves', 'calves': 'calves',
                '臀': 'glutes', 'glute': 'glutes',
                '肩': 'delt_front', 'delt': 'delt_side', 'shoulder': 'delt_side',
                '二头': 'biceps', 'bicep': 'biceps', '三头': 'triceps', 'tricep': 'triceps',
                '腹': 'abs', 'abs': 'abs', 'core': 'abs'
            };
            const str = JSON.stringify(input).toLowerCase();
            const result = [];
            Object.keys(muscleMap).forEach(key => {
                if (str.includes(key)) result.push(muscleMap[key]);
            });
            return result.length > 0 ? result : ['body'];
        };

        // --- 3. UI Components ---
        const Icon = ({ name, size = 20, className, strokeWidth = 2, onClick }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                     lucide.createIcons({
                        icons: { [name]: iconRef.current },
                        attrs: { 'stroke-width': strokeWidth, width: size, height: size, class: className }
                    });
                }
            }, [name, size, className, strokeWidth]);
            return <i ref={iconRef} data-lucide={name} onClick={onClick}></i>;
        };

        const BodyMap = ({ activeMuscles = [], className = "" }) => {
            const getStyle = (pathId) => {
                const isHit = activeMuscles.some(m => pathId.toLowerCase().includes(m.split('_')[0])); 
                // Cleaner look: No glow blur, just solid highlight colors
                return isHit ? "fill-primary" : "fill-surfaceHighlight stroke-[#333] stroke-[0.5]";
            };

            return (
                <svg viewBox="0 0 400 600" xmlns="http://www.w3.org/2000/svg" className={className}>
                    <g id="body_outline">
                        <path d="M200,30 Q230,30 240,70 Q240,100 220,130 L180,130 Q160,100 160,70 Q170,30 200,30" fill="#1c1c1e" stroke="#333" />
                        <path id="traps" d="M160,80 Q140,90 130,120 L150,130 L250,130 L270,120 Q260,90 240,80 Z" className={getStyle('traps')} />
                        <path id="chest" d="M145,130 L255,130 Q265,180 200,210 Q135,180 145,130 Z" className={getStyle('chest')} />
                        <path id="delts" d="M130,120 Q100,130 100,160 L135,170 L145,130 M270,120 Q300,130 300,160 L265,170 L255,130" className={getStyle('delt')} />
                        <path id="arms" d="M135,170 L100,160 L90,280 L130,280 L135,170 M265,170 L300,160 L310,280 L270,280 L265,170" className={getStyle('biceps')} />
                        <path id="abs" d="M160,210 L240,210 L230,320 L170,320 Z" className={getStyle('abs')} />
                        <path id="lats" d="M145,180 L135,260 L160,280 M255,180 L265,260 L240,280" className={getStyle('lats')} />
                        <path id="legs" d="M170,320 L140,330 L150,550 L180,550 L190,340 M230,320 L260,330 L250,550 L220,550 L210,340" className={getStyle('quads')} />
                    </g>
                </svg>
            );
        };

        // --- 4. Main App ---
        const App = () => {
            const [appData, setAppData] = useStorage();
            useExternalLibrary(setAppData); 

            const [view, setView] = useState('templates'); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // UI State
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [newTemplateExercises, setNewTemplateExercises] = useState([]);
            const [showExerciseSelector, setShowExerciseSelector] = useState(false);
            const [exerciseDetails, setExerciseDetails] = useState(null);

            // Workout State
            const [activeWorkoutData, setActiveWorkoutData] = useState({ exercises: [], startTime: null, endTime: null });
            const [durationStr, setDurationStr] = useState("00:00");

            const fullLibrary = useMemo(() => {
                return [...appData.importedLibrary, ...appData.customExercises];
            }, [appData.importedLibrary, appData.customExercises]);

            const getExerciseById = useCallback((id) => {
                return fullLibrary.find(ex => ex.id === id) || { id, name: '未知动作', muscles: [], category: 'CORE' };
            }, [fullLibrary]);

            // --- Actions ---
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iron_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm("恢复数据会覆盖现有记录，确认吗？")) {
                            setAppData(imported);
                            alert("恢复成功");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) { alert("文件格式错误"); }
                };
                reader.readAsText(file);
            };

            const startWorkout = (exercises = []) => {
                const exObjects = exercises.map(exId => {
                    const ex = getExerciseById(exId);
                    return { ...ex, sets: [{ id: Date.now(), weight: '', reps: '', rpe: '', completed: false }] };
                });
                setActiveWorkoutData({ exercises: exObjects, startTime: new Date(), endTime: null });
                setView('workout');
            };

            useEffect(() => {
                if (!activeWorkoutData.startTime || activeWorkoutData.endTime) return;
                const timer = setInterval(() => {
                    const diff = Math.floor((new Date() - activeWorkoutData.startTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    setDurationStr(`${m}:${s < 10 ? '0' : ''}${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [activeWorkoutData.startTime, activeWorkoutData.endTime]);

            // --- Sub-Components ---
            const ExerciseSelector = () => {
                const [filter, setFilter] = useState('CHEST');
                const categories = [
                    { id: 'CHEST', name: '胸部' },
                    { id: 'BACK', name: '背部' },
                    { id: 'LEGS', name: '腿部' },
                    { id: 'SHOULDERS', name: '肩部' },
                    { id: 'ARMS', name: '手臂' },
                    { id: 'GLUTES', name: '臀部' },
                    { id: 'CORE', name: '核心' },
                ];

                const list = fullLibrary.filter(ex => ex.category === filter);

                return (
                    <div className="fixed inset-0 z-50 bg-surface flex flex-col animate-slide-up">
                        <div className="pt-safe px-4 py-4 border-b border-white/5 flex justify-between items-center bg-surface">
                            <h2 className="text-lg font-bold text-white">动作库</h2>
                            <button onClick={() => setShowExerciseSelector(false)} className="text-primary font-medium">关闭</button>
                        </div>
                        <div className="p-4 flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {categories.map(c => (
                                <button key={c.id} onClick={() => setFilter(c.id)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-colors ${filter === c.id ? 'bg-white text-black' : 'bg-surfaceHighlight text-zinc-400'}`}>
                                    {c.name}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto px-4 pb-safe space-y-3">
                            {list.map(ex => (
                                <div key={ex.id} className="p-4 bg-surfaceHighlight rounded-xl flex justify-between items-center active:bg-zinc-700 transition-colors" 
                                     onClick={() => {
                                         if(isCreatingTemplate) setNewTemplateExercises(prev => [...prev, ex]);
                                         else if(activeWorkoutData.startTime) setActiveWorkoutData(prev => ({...prev, exercises: [...prev.exercises, {...ex, sets:[{id:Date.now(), weight:'', reps:'', completed:false}]}]}));
                                         setShowExerciseSelector(false);
                                     }}>
                                    <div>
                                        <div className="text-white font-medium">{ex.name}</div>
                                        <div className="text-xs text-zinc-500 mt-0.5">{ex.rawMuscles ? ex.rawMuscles.join(' · ') : ex.category}</div>
                                    </div>
                                    <div className="flex gap-4 items-center">
                                        {(ex.instructions) && <button onClick={(e)=>{e.stopPropagation(); setExerciseDetails(ex)}} className="text-primary"><Icon name="info" size={20}/></button>}
                                        <span className="text-xs font-bold text-primary bg-primary/10 px-3 py-1 rounded-full">添加</span>
                                    </div>
                                </div>
                            ))}
                            {list.length === 0 && <div className="text-center text-zinc-500 py-10 mt-10">
                                <Icon name="file-question" size={32} className="mx-auto mb-2 opacity-50" />
                                <p>暂无数据</p>
                                <p className="text-xs mt-2">请确认 exercise_library.json 已上传且格式正确</p>
                            </div>}
                        </div>
                    </div>
                );
            };

            const ExerciseInfoModal = () => {
                if (!exerciseDetails) return null;
                return (
                    <div className="fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in" onClick={() => setExerciseDetails(null)}>
                        <div className="bg-surface w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl border border-white/10" onClick={e=>e.stopPropagation()}>
                            <div className="p-4 border-b border-white/10 flex justify-between bg-surfaceHighlight/50">
                                <h3 className="text-white font-bold">{exerciseDetails.name}</h3>
                                <button onClick={() => setExerciseDetails(null)} className="text-zinc-400"><Icon name="x" size={20}/></button>
                            </div>
                            <div className="p-5 space-y-5 max-h-[60vh] overflow-y-auto">
                                <div>
                                    <div className="text-primary text-xs font-bold uppercase mb-2">动作指导</div>
                                    <ul className="list-disc list-inside text-sm text-zinc-300 space-y-1.5 leading-relaxed">
                                        {exerciseDetails.instructions?.map((i,idx)=><li key={idx}>{i}</li>) || <li>暂无说明</li>}
                                    </ul>
                                </div>
                                {exerciseDetails.mistakes && (
                                    <div>
                                        <div className="text-danger text-xs font-bold uppercase mb-2">常见错误</div>
                                        <ul className="list-disc list-inside text-sm text-zinc-300 space-y-1.5 leading-relaxed">
                                            {exerciseDetails.mistakes.map((m,idx)=><li key={idx}>{m}</li>)}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Views ---
            if (view === 'templates') {
                return (
                    <div className="min-h-screen bg-background pb-20">
                        {/* Header */}
                        <div className="pt-safe px-6 py-4 flex justify-between items-center bg-surface/80 backdrop-blur-md sticky top-0 z-10 border-b border-white/5">
                            <h1 className="text-xl font-bold tracking-tight text-white">IRON</h1>
                            <button onClick={() => setIsSettingsOpen(true)} className="text-primary font-medium text-sm">数据</button>
                        </div>

                        {/* Settings Modal */}
                        {isSettingsOpen && (
                            <div className="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fade-in" onClick={() => setIsSettingsOpen(false)}>
                                <div className="bg-surface w-full max-w-md rounded-t-2xl sm:rounded-2xl border-t sm:border border-white/10 p-6 space-y-6 pb-safe" onClick={e=>e.stopPropagation()}>
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-white">设置</h2>
                                        <button onClick={() => setIsSettingsOpen(false)} className="text-primary font-bold">完成</button>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={handleExport} className="w-full py-4 bg-surfaceHighlight rounded-xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform">
                                            <div className="bg-primary/20 p-2 rounded-lg text-primary"><Icon name="download" size={18} /></div>
                                            <span className="flex-1 text-left">备份数据 (导出 JSON)</span>
                                        </button>
                                        <label className="w-full py-4 bg-surfaceHighlight rounded-xl flex items-center px-4 gap-3 text-white font-medium active:scale-98 transition-transform cursor-pointer">
                                            <div className="bg-accent/20 p-2 rounded-lg text-accent"><Icon name="upload" size={18} /></div>
                                            <span className="flex-1 text-left">恢复数据 (导入 JSON)</span>
                                            <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                        </label>
                                        <div className="p-4 rounded-xl bg-surfaceHighlight/50 border border-white/5">
                                            <div className="flex justify-between items-center text-sm">
                                                <span className="text-zinc-400">外部动作库</span>
                                                {appData.importedLibrary.length > 0 ? 
                                                    <span className="text-accent flex items-center gap-1"><Icon name="check-circle" size={14}/> 已连接 ({appData.importedLibrary.length})</span> : 
                                                    <span className="text-zinc-500 flex items-center gap-1"><Icon name="alert-circle" size={14}/> 未检测到</span>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Content */}
                        <div className="px-4 mt-6 space-y-4">
                            {appData.templates.length === 0 ? (
                                <div className="py-20 text-center">
                                    <div className="w-16 h-16 bg-surfaceHighlight rounded-2xl flex items-center justify-center mx-auto mb-4 text-zinc-500">
                                        <Icon name="clipboard-list" size={32} />
                                    </div>
                                    <h3 className="text-white font-bold text-lg">暂无计划</h3>
                                    <p className="text-zinc-500 text-sm mt-2 mb-8">创建您的第一个训练计划</p>
                                    <button onClick={() => setIsCreatingTemplate(true)} className="bg-primary text-white px-8 py-3 rounded-full font-bold text-sm active:opacity-80">
                                        新建计划
                                    </button>
                                </div>
                            ) : (
                                appData.templates.map(t => (
                                    <div key={t.id} onClick={() => startWorkout(t.exercises)} className="bg-surfaceHighlight rounded-xl p-4 flex justify-between items-center active:bg-zinc-700 transition-colors cursor-pointer">
                                        <div>
                                            <h3 className="text-lg font-bold text-white">{t.name}</h3>
                                            <p className="text-xs text-zinc-500 mt-1">{t.exercises.length} 个动作</p>
                                        </div>
                                        <Icon name="chevron-right" className="text-zinc-600" size={20} />
                                    </div>
                                ))
                            )}
                            
                            {appData.templates.length > 0 && (
                                <button onClick={() => setIsCreatingTemplate(true)} className="w-full py-3.5 bg-primary/10 text-primary font-bold rounded-xl mt-4 active:scale-98 transition-transform">
                                    + 新建计划
                                </button>
                            )}
                        </div>
                        
                        {/* iOS Standard Bottom Tab Bar */}
                        <div className="fixed bottom-0 left-0 right-0 glass pb-safe pt-2 px-6 flex justify-around border-t border-white/10 z-20">
                            <button className="flex flex-col items-center p-1 w-16 text-primary">
                                <Icon name="layout-list" size={26} strokeWidth={2} />
                                <span className="text-[10px] font-medium mt-1">计划</span>
                            </button>
                            <button className="flex flex-col items-center p-1 w-16 text-zinc-500">
                                <Icon name="bar-chart-2" size={26} strokeWidth={2} />
                                <span className="text-[10px] font-medium mt-1">历史</span>
                            </button>
                        </div>
                    </div>
                );
            }

            // Create Template View
            if (isCreatingTemplate) {
                return (
                    <div className="min-h-screen bg-background pb-safe flex flex-col animate-slide-up">
                        <div className="pt-safe px-4 py-4 border-b border-white/10 flex justify-between items-center bg-surface sticky top-0 z-10">
                            <button onClick={() => setIsCreatingTemplate(false)} className="text-primary text-sm font-medium">取消</button>
                            <span className="font-bold text-white">新计划</span>
                            <button onClick={() => {
                                if(!newTemplateName) return alert('请输入名称');
                                setAppData(prev => ({...prev, templates: [...prev.templates, {id: Date.now(), name: newTemplateName, exercises: newTemplateExercises.map(e=>e.id)}]}));
                                setIsCreatingTemplate(false); setNewTemplateName(''); setNewTemplateExercises([]);
                            }} className="text-primary font-bold text-sm">保存</button>
                        </div>
                        <div className="p-4 space-y-6 flex-1 overflow-y-auto">
                            <div className="bg-surfaceHighlight rounded-xl p-4">
                                <input value={newTemplateName} onChange={e => setNewTemplateName(e.target.value)} placeholder="计划名称 (例如: 胸肌训练 A)" className="w-full bg-transparent text-lg font-medium text-white outline-none placeholder-zinc-600" autoFocus />
                            </div>
                            
                            <div>
                                <div className="text-xs text-zinc-500 font-bold uppercase mb-2 ml-2">动作列表</div>
                                <div className="space-y-1">
                                    {newTemplateExercises.map((ex, i) => (
                                        <div key={i} className="p-4 bg-surfaceHighlight rounded-xl flex justify-between items-center">
                                            <span className="text-white font-medium">{ex.name}</span>
                                            <button onClick={() => setNewTemplateExercises(prev => prev.filter((_, idx) => idx !== i))} className="text-danger"><Icon name="minus-circle" size={20}/></button>
                                        </div>
                                    ))}
                                    <button onClick={() => setShowExerciseSelector(true)} className="w-full py-4 bg-surfaceHighlight rounded-xl text-primary font-bold flex items-center justify-center gap-2 active:bg-zinc-700">
                                        <Icon name="plus" size={18} /> 添加动作
                                    </button>
                                </div>
                            </div>
                        </div>
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            // Workout View
            if (view === 'workout') {
                return (
                    <div className="min-h-screen bg-black pb-safe">
                        <div className="sticky top-0 z-30 pt-safe bg-surface/90 backdrop-blur border-b border-white/10 px-4 py-3 flex justify-between items-center">
                            <button onClick={() => setView('templates')} className="text-zinc-400"><Icon name="chevron-down" size={24} /></button>
                            <span className="font-mono text-white font-bold tabular-nums text-lg">{durationStr}</span>
                            <button className="bg-primary text-white text-xs font-bold px-4 py-1.5 rounded-full" onClick={() => setView('templates')}>完成</button>
                        </div>
                        <div className="p-4 space-y-6">
                            {activeWorkoutData.exercises.map((ex, i) => (
                                <div key={i} className="bg-surfaceHighlight/30 rounded-2xl p-4 border border-white/5">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold text-white flex gap-2 items-center">
                                            {ex.name}
                                            {ex.instructions && <button onClick={()=>setExerciseDetails(ex)} className="text-primary"><Icon name="info" size={18}/></button>}
                                        </h3>
                                    </div>
                                    <div className="space-y-2">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className={`grid grid-cols-[20px_1fr_1fr_1fr_40px] gap-2 items-center ${set.completed ? 'opacity-40' : ''}`}>
                                                <span className="text-zinc-500 text-xs font-mono font-bold">{sIdx+1}</span>
                                                <input placeholder="KG" className="bg-surfaceHighlight rounded-lg py-2.5 text-center text-white font-bold border-none outline-none focus:ring-1 focus:ring-primary" type="number" />
                                                <input placeholder="Reps" className="bg-surfaceHighlight rounded-lg py-2.5 text-center text-white font-bold border-none outline-none focus:ring-1 focus:ring-primary" type="number" />
                                                <input placeholder="RPE" className="bg-surfaceHighlight rounded-lg py-2.5 text-center text-white font-bold border-none outline-none focus:ring-1 focus:ring-primary" type="number" />
                                                <button onClick={()=>{
                                                    const newExs = [...activeWorkoutData.exercises];
                                                    newExs[i].sets[sIdx].completed = !newExs[i].sets[sIdx].completed;
                                                    setActiveWorkoutData(prev=>({...prev, exercises: newExs}));
                                                }} className={`h-11 rounded-lg flex items-center justify-center transition-colors ${set.completed ? 'bg-primary text-white' : 'bg-surfaceHighlight text-zinc-600'}`}>
                                                    <Icon name="check" size={18} strokeWidth={3} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        {exerciseDetails && <ExerciseInfoModal />}
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
