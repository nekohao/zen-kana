<!DOCTYPE html>
<html lang="zh-CN" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IRON</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: '#000000', 
                        surface: '#09090b',
                        surfaceLight: '#18181b',
                        surfaceHighlight: '#27272a',
                        primary: '#3b82f6',    
                        accent: '#10b981',     
                        danger: '#ef4444',     
                        cyber: '#22d3ee',      
                        neonPurple: '#d946ef',
                    },
                    fontFamily: {
                        mono: ['SF Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['SF Pro Display', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'breath': 'breath 3s ease-in-out infinite',
                        'fade-in': 'fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        breath: {
                            '0%, 100%': { opacity: '0.5', filter: 'drop-shadow(0 0 2px rgba(34,211,238,0.3))' },
                            '50%': { opacity: '1', filter: 'drop-shadow(0 0 10px rgba(34,211,238,0.6))' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.98)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #000000; 
            color: #e4e4e7; 
            -webkit-tap-highlight-color: transparent;
            font-feature-settings: "ss01", "ss02"; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass {
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-card {
            background: #121212;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
    </style>
</head>
<body class="h-full selection:bg-cyber selection:text-black">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- 1. Data Models & Storage ---
        const STORAGE_KEY = 'iron_app_data_v5';

        const initialData = {
            templates: [], 
            customExercises: [], 
            history: {},
            importedLibrary: [] // Stores content from exercise_library.json
        };

        const useStorage = () => {
            const [data, setData] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : initialData;
                } catch (e) {
                    return initialData;
                }
            });

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data]);

            return [data, setData];
        };

        // --- 2. External Data Loading & Parsing ---
        const useExternalLibrary = (setAppData) => {
            useEffect(() => {
                const fetchLibrary = async () => {
                    try {
                        // Fetch from same directory
                        const response = await fetch('./exercise_library.json');
                        if (!response.ok) throw new Error('Network response was not ok');
                        
                        const json = await response.json();
                        let exercises = [];

                        // Strategy 1: "library" array (Snippet 1 format)
                        if (json.library && Array.isArray(json.library)) {
                            exercises = [...exercises, ...json.library.map(ex => ({
                                ...ex,
                                category: normalizeCategory(ex.muscle_group),
                                muscles: normalizeMuscles(ex.muscle_group)
                            }))];
                        }

                        // Strategy 2: Key-based categories (Snippet 2 format: "Back": [], "Legs": [])
                        const keys = Object.keys(json);
                        keys.forEach(key => {
                            if (Array.isArray(json[key]) && key !== 'library') {
                                // Assume key is category name (e.g., "Back")
                                const catExercises = json[key].map(ex => ({
                                    id: `ext_${key}_${ex.name.replace(/\s+/g, '')}`,
                                    name: ex.name,
                                    category: normalizeCategory([key]), // Use the key as hint
                                    muscles: normalizeMuscles([...(ex.primary_muscle || []), ...(ex.secondary_muscle || [])]),
                                    rawMuscles: ex.primary_muscle,
                                    instructions: ex.cues || ex.instructions,
                                    mistakes: ex.common_mistakes
                                }));
                                exercises = [...exercises, ...catExercises];
                            }
                        });

                        if (exercises.length > 0) {
                            console.log(`Loaded ${exercises.length} external exercises.`);
                            setAppData(prev => ({
                                ...prev,
                                importedLibrary: exercises
                            }));
                        }

                    } catch (error) {
                        console.log("Could not load external library (Dev Mode or file missing):", error);
                    }
                };

                fetchLibrary();
            }, []);
        };

        // Helper: Convert various muscle names to internal IDs
        const normalizeCategory = (input) => {
            const str = JSON.stringify(input).toLowerCase();
            if (str.includes('chest') || str.includes('胸')) return 'CHEST';
            if (str.includes('back') || str.includes('背') || str.includes('lats')) return 'BACK';
            if (str.includes('leg') || str.includes('腿') || str.includes('squat') || str.includes('quad')) return 'LEGS';
            if (str.includes('glute') || str.includes('臀')) return 'GLUTES';
            if (str.includes('shoulder') || str.includes('delt') || str.includes('肩')) return 'SHOULDERS';
            if (str.includes('arm') || str.includes('biceps') || str.includes('triceps') || str.includes('臂') || str.includes('二头') || str.includes('三头')) return 'ARMS';
            return 'CORE';
        };

        const normalizeMuscles = (input) => {
            const muscleMap = {
                '胸': 'chest_major', 'chest': 'chest_major', 'pec': 'chest_major',
                '背': 'lats', 'lat': 'lats', 'traps': 'traps_upper',
                '腿': 'quads', 'quad': 'quads', 'hamstring': 'hamstrings', 'calf': 'calves', 'calves': 'calves',
                '臀': 'glutes', 'glute': 'glutes',
                '肩': 'delt_front', 'delt': 'delt_side', 'shoulder': 'delt_side',
                '二头': 'biceps', 'bicep': 'biceps', '三头': 'triceps', 'tricep': 'triceps',
                '腹': 'abs', 'abs': 'abs', 'core': 'abs'
            };
            const str = JSON.stringify(input).toLowerCase();
            const result = [];
            Object.keys(muscleMap).forEach(key => {
                if (str.includes(key)) result.push(muscleMap[key]);
            });
            return result.length > 0 ? result : ['body'];
        };

        // --- 3. UI Components ---
        const Icon = ({ name, size = 20, className, strokeWidth = 2, onClick }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current) {
                     lucide.createIcons({
                        icons: { [name]: iconRef.current },
                        attrs: { 'stroke-width': strokeWidth, width: size, height: size, class: className }
                    });
                }
            }, [name, size, className, strokeWidth]);
            return <i ref={iconRef} data-lucide={name} onClick={onClick}></i>;
        };

        const BodyMap = ({ activeMuscles = [], className = "" }) => {
            const getStyle = (pathId) => {
                // Simplified matching for demo
                const isHit = activeMuscles.some(m => pathId.toLowerCase().includes(m.split('_')[0])); 
                return isHit 
                    ? "fill-cyber animate-breath filter drop-shadow-[0_0_8px_rgba(34,211,238,0.6)]" 
                    : "fill-surfaceLight stroke-zinc-800 stroke-[0.5]";
            };

            return (
                <svg viewBox="0 0 400 600" xmlns="http://www.w3.org/2000/svg" className={className}>
                    <g id="body_outline">
                         {/* Core Body Shape */}
                        <path d="M200,30 Q230,30 240,70 Q240,100 220,130 L180,130 Q160,100 160,70 Q170,30 200,30" fill="#18181b" stroke="#333" />
                        <path id="traps" d="M160,80 Q140,90 130,120 L150,130 L250,130 L270,120 Q260,90 240,80 Z" className={getStyle('traps')} />
                        <path id="chest" d="M145,130 L255,130 Q265,180 200,210 Q135,180 145,130 Z" className={getStyle('chest')} />
                        <path id="delts" d="M130,120 Q100,130 100,160 L135,170 L145,130 M270,120 Q300,130 300,160 L265,170 L255,130" className={getStyle('delt')} />
                        <path id="arms" d="M135,170 L100,160 L90,280 L130,280 L135,170 M265,170 L300,160 L310,280 L270,280 L265,170" className={getStyle('biceps')} />
                        <path id="abs" d="M160,210 L240,210 L230,320 L170,320 Z" className={getStyle('abs')} />
                        <path id="lats" d="M145,180 L135,260 L160,280 M255,180 L265,260 L240,280" className={getStyle('lats')} />
                        <path id="legs" d="M170,320 L140,330 L150,550 L180,550 L190,340 M230,320 L260,330 L250,550 L220,550 L210,340" className={getStyle('quads')} />
                    </g>
                </svg>
            );
        };

        // --- 4. Main App ---
        const App = () => {
            const [appData, setAppData] = useStorage();
            useExternalLibrary(setAppData); // Hook to load JSON

            const [view, setView] = useState('templates'); 
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            
            // UI State
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
            const [newTemplateName, setNewTemplateName] = useState('');
            const [newTemplateExercises, setNewTemplateExercises] = useState([]);
            const [showExerciseSelector, setShowExerciseSelector] = useState(false);
            const [exerciseDetails, setExerciseDetails] = useState(null);

            // Workout State
            const [activeWorkoutData, setActiveWorkoutData] = useState({ exercises: [], startTime: null, endTime: null });
            const [durationStr, setDurationStr] = useState("00:00");

            // --- Database Access ---
            const fullLibrary = useMemo(() => {
                // Merge Default + Imported + Custom
                const defaultDB = []; // Could put hardcoded fallback here if needed
                return [...defaultDB, ...appData.importedLibrary, ...appData.customExercises];
            }, [appData.importedLibrary, appData.customExercises]);

            const getExerciseById = useCallback((id) => {
                return fullLibrary.find(ex => ex.id === id) || { id, name: '未知动作', muscles: [], category: 'CORE' };
            }, [fullLibrary]);

            // --- Actions ---
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(appData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `iron_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (confirm("导入将覆盖当前所有数据，确定吗？")) {
                            setAppData(imported);
                            alert("数据恢复成功！");
                            setIsSettingsOpen(false);
                        }
                    } catch (err) {
                        alert("文件格式错误");
                    }
                };
                reader.readAsText(file);
            };

            const startWorkout = (exercises = []) => {
                const exObjects = exercises.map(exId => {
                    const ex = getExerciseById(exId);
                    return { ...ex, sets: [{ id: Date.now(), weight: '', reps: '', rpe: '', completed: false }] };
                });
                setActiveWorkoutData({ exercises: exObjects, startTime: new Date(), endTime: null });
                setView('workout');
            };

            // Timer
            useEffect(() => {
                if (!activeWorkoutData.startTime || activeWorkoutData.endTime) return;
                const timer = setInterval(() => {
                    const diff = Math.floor((new Date() - activeWorkoutData.startTime) / 1000);
                    const m = Math.floor(diff / 60);
                    const s = diff % 60;
                    setDurationStr(`${m}:${s < 10 ? '0' : ''}${s}`);
                }, 1000);
                return () => clearInterval(timer);
            }, [activeWorkoutData.startTime, activeWorkoutData.endTime]);

            // --- Sub-Components ---
            const CategoryButton = ({ label, icon, onClick, active }) => (
                <button onClick={onClick} className={`flex flex-col items-center justify-center p-4 rounded-xl border transition-all ${active ? 'bg-cyber text-black border-cyber' : 'bg-surfaceLight border-white/5 text-zinc-400'}`}>
                    <Icon name={icon} size={24} />
                    <span className="text-xs font-bold mt-2">{label}</span>
                </button>
            );

            const ExerciseSelector = () => {
                const [filter, setFilter] = useState('CHEST');
                const categories = [
                    { id: 'CHEST', name: '胸部', icon: 'dumbbell' },
                    { id: 'BACK', name: '背部', icon: 'move' },
                    { id: 'LEGS', name: '腿部', icon: 'footprints' },
                    { id: 'SHOULDERS', name: '肩部', icon: 'user' },
                    { id: 'ARMS', name: '手臂', icon: 'biceps-flexed' },
                    { id: 'GLUTES', name: '臀部', icon: 'disc' },
                    { id: 'CORE', name: '核心', icon: 'target' },
                ];

                const list = fullLibrary.filter(ex => ex.category === filter);

                return (
                    <div className="fixed inset-0 z-50 bg-surface flex flex-col animate-fade-in">
                        <div className="pt-safe px-4 py-4 border-b border-white/10 flex justify-between items-center bg-surfaceHighlight">
                            <h2 className="text-lg font-bold text-white">动作库</h2>
                            <button onClick={() => setShowExerciseSelector(false)}><Icon name="x" className="text-zinc-400" /></button>
                        </div>
                        <div className="p-4 grid grid-cols-4 gap-2">
                            {categories.map(c => (
                                <button key={c.id} onClick={() => setFilter(c.id)} className={`py-2 rounded-lg text-xs font-bold ${filter === c.id ? 'bg-white text-black' : 'bg-surfaceLight text-zinc-500'}`}>
                                    {c.name}
                                </button>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto px-4 pb-safe space-y-2">
                            {list.map(ex => (
                                <div key={ex.id} className="p-4 bg-surfaceLight border border-white/5 rounded-xl flex justify-between items-center" 
                                     onClick={() => {
                                         if(isCreatingTemplate) setNewTemplateExercises(prev => [...prev, ex]);
                                         else if(activeWorkoutData.startTime) setActiveWorkoutData(prev => ({...prev, exercises: [...prev.exercises, {...ex, sets:[{id:Date.now(), weight:'', reps:'', completed:false}]}]}));
                                         setShowExerciseSelector(false);
                                     }}>
                                    <div>
                                        <div className="text-white font-bold">{ex.name}</div>
                                        <div className="text-xs text-zinc-500 mt-1">{ex.rawMuscles ? ex.rawMuscles.join(' / ') : ex.category}</div>
                                    </div>
                                    <div className="flex gap-3">
                                        {(ex.instructions) && <button onClick={(e)=>{e.stopPropagation(); setExerciseDetails(ex)}} className="text-zinc-500 hover:text-cyber"><Icon name="info" size={18}/></button>}
                                        <Icon name="plus-circle" className="text-cyber" />
                                    </div>
                                </div>
                            ))}
                            {list.length === 0 && <div className="text-center text-zinc-500 py-10">暂无数据，请检查 exercise_library.json 是否存在</div>}
                        </div>
                    </div>
                );
            };

            const ExerciseInfoModal = () => {
                if (!exerciseDetails) return null;
                return (
                    <div className="fixed inset-0 z-[60] bg-black/80 flex items-center justify-center p-6 animate-fade-in" onClick={() => setExerciseDetails(null)}>
                        <div className="bg-surfaceHighlight border border-white/10 w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                            <div className="p-4 border-b border-white/10 flex justify-between">
                                <h3 className="text-white font-bold">{exerciseDetails.name}</h3>
                                <button onClick={() => setExerciseDetails(null)}><Icon name="x" className="text-zinc-400"/></button>
                            </div>
                            <div className="p-5 space-y-4 max-h-[60vh] overflow-y-auto">
                                <div>
                                    <div className="text-cyber text-xs font-bold uppercase mb-2">Instructions</div>
                                    <ul className="list-disc list-inside text-sm text-zinc-300 space-y-1">
                                        {exerciseDetails.instructions?.map((i,idx)=><li key={idx}>{i}</li>) || <li>暂无说明</li>}
                                    </ul>
                                </div>
                                {exerciseDetails.mistakes && (
                                    <div>
                                        <div className="text-danger text-xs font-bold uppercase mb-2">Mistakes</div>
                                        <ul className="list-disc list-inside text-sm text-zinc-300 space-y-1">
                                            {exerciseDetails.mistakes.map((m,idx)=><li key={idx}>{m}</li>)}
                                        </ul>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Views ---
            if (view === 'templates') {
                return (
                    <div className="min-h-screen bg-background pb-20">
                        {/* Header */}
                        <div className="pt-safe px-6 py-6 flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-black italic tracking-tighter text-white">IRON</h1>
                                <p className="text-zinc-500 text-[10px] font-mono tracking-widest uppercase">v5.0 Pro</p>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="text-zinc-400 hover:text-white transition-colors">
                                <Icon name="settings-2" size={24} />
                            </button>
                        </div>

                        {/* Settings Modal */}
                        {isSettingsOpen && (
                            <div className="fixed inset-0 z-50 bg-black/90 flex items-end sm:items-center justify-center animate-fade-in">
                                <div className="bg-surface w-full max-w-md rounded-t-2xl sm:rounded-2xl border-t sm:border border-white/10 p-6 space-y-6">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-white">数据管理</h2>
                                        <button onClick={() => setIsSettingsOpen(false)}><Icon name="x" className="text-zinc-400" /></button>
                                    </div>
                                    <div className="space-y-3">
                                        <button onClick={handleExport} className="w-full py-4 bg-surfaceLight border border-white/5 rounded-xl flex items-center justify-center gap-3 text-white font-bold active:scale-95 transition-transform">
                                            <Icon name="download" size={18} className="text-cyber" /> 备份数据 (导出 JSON)
                                        </button>
                                        <label className="w-full py-4 bg-surfaceLight border border-white/5 rounded-xl flex items-center justify-center gap-3 text-white font-bold active:scale-95 transition-transform cursor-pointer">
                                            <Icon name="upload" size={18} className="text-accent" /> 恢复数据 (导入 JSON)
                                            <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                        </label>
                                        <div className="text-center text-xs text-zinc-600 mt-4">
                                            提示：若 App 删除或更换设备，可使用此功能迁移数据。<br/>
                                            外部动作库状态: {appData.importedLibrary.length > 0 ? <span className="text-accent">已连接 ({appData.importedLibrary.length})</span> : <span className="text-zinc-500">未检测到</span>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Content */}
                        <div className="px-6 space-y-4">
                            {appData.templates.length === 0 ? (
                                <div className="glass-card rounded-2xl p-8 text-center mt-10">
                                    <Icon name="dumbbell" size={48} className="text-zinc-700 mx-auto mb-4" />
                                    <h3 className="text-white font-bold text-lg">开始你的训练</h3>
                                    <p className="text-zinc-500 text-sm mt-2 mb-6">创建一个计划，或直接从动作库开始。</p>
                                    <button onClick={() => setIsCreatingTemplate(true)} className="bg-white text-black px-6 py-3 rounded-xl font-bold text-sm inline-flex items-center gap-2">
                                        <Icon name="plus" size={16} /> 创建计划
                                    </button>
                                </div>
                            ) : (
                                appData.templates.map(t => (
                                    <div key={t.id} onClick={() => startWorkout(t.exercises)} className="glass-card rounded-xl p-5 active:bg-surfaceHighlight transition-colors cursor-pointer border border-white/5 hover:border-cyber/50 group relative overflow-hidden">
                                        <div className="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-cyber/10 to-transparent rounded-bl-3xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                        <div className="flex justify-between items-center relative z-10">
                                            <div>
                                                <h3 className="text-lg font-bold text-white">{t.name}</h3>
                                                <p className="text-xs text-zinc-500 mt-1 font-mono">{t.exercises.length} 个动作</p>
                                            </div>
                                            <Icon name="chevron-right" className="text-zinc-600 group-hover:text-white" />
                                        </div>
                                    </div>
                                ))
                            )}
                            
                            <button onClick={() => setIsCreatingTemplate(true)} className="w-full py-4 border border-dashed border-zinc-800 rounded-xl text-zinc-500 font-bold hover:text-white hover:border-zinc-600 transition-colors flex justify-center items-center gap-2">
                                <Icon name="plus" size={18} /> 新建计划
                            </button>
                        </div>
                        
                        {/* Cleaner Bottom Nav */}
                        <div className="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 px-6 flex justify-around">
                            <button className="flex flex-col items-center p-2 text-cyber">
                                <Icon name="layout-grid" size={24} />
                                <span className="text-[10px] font-bold mt-1">计划</span>
                            </button>
                            <button className="flex flex-col items-center p-2 text-zinc-600 hover:text-white">
                                <Icon name="history" size={24} />
                                <span className="text-[10px] font-bold mt-1">历史</span>
                            </button>
                        </div>
                    </div>
                );
            }

            // Create Template View
            if (isCreatingTemplate) {
                return (
                    <div className="min-h-screen bg-surface pb-safe flex flex-col animate-fade-in">
                        <div className="pt-safe px-4 py-4 border-b border-white/10 flex justify-between items-center bg-surfaceHighlight">
                            <button onClick={() => setIsCreatingTemplate(false)} className="text-zinc-400">取消</button>
                            <span className="font-bold text-white">新计划</span>
                            <button onClick={() => {
                                if(!newTemplateName) return alert('请输入名称');
                                setAppData(prev => ({...prev, templates: [...prev.templates, {id: Date.now(), name: newTemplateName, exercises: newTemplateExercises.map(e=>e.id)}]}));
                                setIsCreatingTemplate(false); setNewTemplateName(''); setNewTemplateExercises([]);
                            }} className="text-cyber font-bold">保存</button>
                        </div>
                        <div className="p-6 space-y-6 flex-1 overflow-y-auto">
                            <input value={newTemplateName} onChange={e => setNewTemplateName(e.target.value)} placeholder="计划名称 (如: 推胸日)" className="w-full bg-transparent text-2xl font-bold text-white outline-none placeholder-zinc-700" autoFocus />
                            <div className="space-y-2">
                                {newTemplateExercises.map((ex, i) => (
                                    <div key={i} className="p-4 bg-surfaceLight rounded-xl flex justify-between items-center border border-white/5">
                                        <span className="text-zinc-300 font-bold">{ex.name}</span>
                                        <button onClick={() => setNewTemplateExercises(prev => prev.filter((_, idx) => idx !== i))} className="text-zinc-600 hover:text-danger"><Icon name="trash-2" size={18}/></button>
                                    </div>
                                ))}
                                <button onClick={() => setShowExerciseSelector(true)} className="w-full py-4 bg-surfaceLight border border-white/5 rounded-xl text-cyber font-bold flex justify-center gap-2">
                                    <Icon name="plus" size={18} /> 添加动作
                                </button>
                            </div>
                        </div>
                        {showExerciseSelector && <ExerciseSelector />}
                    </div>
                );
            }

            // Workout View
            if (view === 'workout') {
                return (
                    <div className="min-h-screen bg-black pb-safe">
                        <div className="sticky top-0 z-30 pt-safe bg-surface/90 backdrop-blur border-b border-white/10 px-4 py-2 flex justify-between items-center">
                            <button onClick={() => setView('templates')}><Icon name="chevron-down" className="text-zinc-400" /></button>
                            <span className="font-mono text-cyber font-bold">{durationStr}</span>
                            <button className="bg-white text-black text-xs font-bold px-3 py-1 rounded-md" onClick={() => setView('templates')}>结束</button>
                        </div>
                        <div className="p-4 space-y-6">
                            {activeWorkoutData.exercises.map((ex, i) => (
                                <div key={i}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="text-xl font-bold text-white flex gap-2 items-center">
                                            {ex.name}
                                            {ex.instructions && <button onClick={()=>setExerciseDetails(ex)} className="text-zinc-600 hover:text-cyber"><Icon name="info" size={16}/></button>}
                                        </h3>
                                    </div>
                                    <div className="space-y-2">
                                        {ex.sets.map((set, sIdx) => (
                                            <div key={sIdx} className={`grid grid-cols-[20px_1fr_1fr_1fr_40px] gap-2 items-center ${set.completed ? 'opacity-40' : ''}`}>
                                                <span className="text-zinc-600 text-xs font-mono">{sIdx+1}</span>
                                                <input placeholder="KG" className="bg-surfaceLight rounded-md py-2 text-center text-white font-bold" />
                                                <input placeholder="Reps" className="bg-surfaceLight rounded-md py-2 text-center text-white font-bold" />
                                                <input placeholder="RPE" className="bg-surfaceLight rounded-md py-2 text-center text-white font-bold" />
                                                <button onClick={()=>{
                                                    const newExs = [...activeWorkoutData.exercises];
                                                    newExs[i].sets[sIdx].completed = !newExs[i].sets[sIdx].completed;
                                                    setActiveWorkoutData(prev=>({...prev, exercises: newExs}));
                                                }} className={`h-10 rounded-md flex items-center justify-center ${set.completed ? 'bg-cyber text-black' : 'bg-surfaceLight text-zinc-600'}`}>
                                                    <Icon name="check" size={16} strokeWidth={3} />
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        {exerciseDetails && <ExerciseInfoModal />}
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
